import SwiftUIimport ParseSwiftstruct MessagesView: View {    @StateObject private var viewModel = MessagesViewModel()    @State private var selectedTab: MessageTab = .clubs        enum MessageTab {        case clubs        case dms    }        var body: some View {        NavigationView {            VStack(spacing: 0) {                Picker("Messages", selection: $selectedTab) {                    Text("Clubs").tag(MessageTab.clubs)                    Text("DMs").tag(MessageTab.dms)                }                .pickerStyle(SegmentedPickerStyle())                .padding()                                Divider()                                if selectedTab == .clubs {                    clubMessagesView                } else {                    dmMessagesView                }            }            .navigationTitle("Messages")        }        .onAppear {            viewModel.loadUserClubs()        }    }        var clubMessagesView: some View {        Group {            if viewModel.isLoadingClubs {                VStack {                    ProgressView()                        .padding(.top, 40)                    Spacer()                }            } else if viewModel.userClubs.isEmpty {                VStack {                    VStack(spacing: 20) {                        Image(systemName: "bubble.left.and.bubble.right")                            .font(.system(size: 60))                            .foregroundColor(.gray)                        Text("No Club Messages")                            .font(.system(size: 20, weight: .semibold))                        Text("Join clubs to see their messages")                            .font(.system(size: 14))                            .foregroundColor(.gray)                            .multilineTextAlignment(.center)                            .padding(.horizontal, 40)                    }                    .padding(.top, 80)                    Spacer()                }            } else {                ScrollView {                    VStack(spacing: 0) {                        ForEach(viewModel.userClubs, id: \.objectId) { club in                            NavigationLink(destination: ClubChatView(club: club)) {                                ClubMessageRow(club: club)                            }                            .buttonStyle(PlainButtonStyle())                            Divider().padding(.leading, 80)                        }                    }                }            }        }    }        var dmMessagesView: some View {        VStack {            VStack(spacing: 20) {                Image(systemName: "envelope.open")                    .font(.system(size: 60))                    .foregroundColor(.gray)                Text("Direct Messages")                    .font(.system(size: 20, weight: .semibold))                Text("Coming soon!")                    .font(.system(size: 14))                    .foregroundColor(.gray)            }            .padding(.top, 80)            Spacer()        }    }}struct ClubMessageRow: View {    let club: Club        var body: some View {        HStack(spacing: 16) {            Circle()                .fill(Color.black)                .frame(width: 56, height: 56)                .overlay(                    Text(club.name?.prefix(1).uppercased() ?? "C")                        .font(.system(size: 24, weight: .bold))                        .foregroundColor(.white)                )                        VStack(alignment: .leading, spacing: 6) {                Text(club.name ?? "Club")                    .font(.system(size: 16, weight: .semibold))                    .foregroundColor(.black)                                HStack(spacing: 8) {                    Text("#general")                        .font(.system(size: 14))                        .foregroundColor(.gray)                                        Text("‚Ä¢")                        .foregroundColor(.gray)                                        Text("\(club.memberCount ?? 0) members")                        .font(.system(size: 13))                        .foregroundColor(.gray)                }            }                        Spacer()                        Image(systemName: "chevron.right")                .foregroundColor(.gray)                .font(.system(size: 14))        }        .padding()    }}struct ClubChatView: View {    let club: Club    @StateObject private var viewModel: ClubChatViewModel    @State private var messageText = ""        init(club: Club) {        self.club = club        _viewModel = StateObject(wrappedValue: ClubChatViewModel(club: club))    }        var body: some View {        VStack(spacing: 0) {            ScrollView {                LazyVStack(spacing: 16) {                    ForEach(viewModel.messages, id: \.objectId) { message in                        MessageBubble(message: message)                    }                }                .padding()            }                        Divider()                        HStack(spacing: 12) {                TextField("Type a message...", text: $messageText)                    .textFieldStyle(PlainTextFieldStyle())                    .padding(12)                    .background(Color.gray.opacity(0.1))                    .cornerRadius(20)                                Button(action: {                    sendMessage()                }) {                    Image(systemName: "arrow.up.circle.fill")                        .font(.system(size: 32))                        .foregroundColor(messageText.isEmpty ? .gray : .black)                }                .disabled(messageText.isEmpty)            }            .padding()        }        .navigationTitle(club.name ?? "Club Chat")        .navigationBarTitleDisplayMode(.inline)        .onAppear {            viewModel.loadMessages()        }    }        func sendMessage() {        guard !messageText.isEmpty else { return }                let text = messageText        messageText = ""                viewModel.sendMessage(text: text)    }}struct MessageBubble: View {    let message: ClubMessage        var isCurrentUser: Bool {        message.userId == User.current?.objectId    }        var body: some View {        HStack {            if isCurrentUser {                Spacer()            }                        VStack(alignment: isCurrentUser ? .trailing : .leading, spacing: 4) {                if !isCurrentUser {                    Text(message.username ?? "User")                        .font(.system(size: 12, weight: .semibold))                        .foregroundColor(.gray)                }                                Text(message.text ?? "")                    .font(.system(size: 15))                    .foregroundColor(isCurrentUser ? .white : .black)                    .padding(.horizontal, 16)                    .padding(.vertical, 10)                    .background(isCurrentUser ? Color.black : Color.gray.opacity(0.2))                    .cornerRadius(18)                                if let createdAt = message.createdAt {                    Text(formatTime(createdAt))                        .font(.system(size: 11))                        .foregroundColor(.gray)                }            }                        if !isCurrentUser {                Spacer()            }        }    }        func formatTime(_ date: Date) -> String {        let formatter = DateFormatter()        formatter.timeStyle = .short        return formatter.string(from: date)    }}class MessagesViewModel: ObservableObject {    @Published var userClubs: [Club] = []    @Published var isLoadingClubs = false        func loadUserClubs() {        guard let userId = User.current?.objectId else {            print("‚ùå No current user")            return        }                isLoadingClubs = true                print("üì± Loading clubs for user: \(userId)")                Task {            do {                let clubs = try await ParseService.shared.getUserClubs(userId: userId)                await MainActor.run {                    self.userClubs = clubs                    self.isLoadingClubs = false                    print("‚úÖ Loaded \(clubs.count) clubs")                                        if clubs.isEmpty {                        print("‚ÑπÔ∏è User is not a member of any clubs")                    } else {                        for club in clubs {                            print("   - \(club.name ?? "Unknown club")")                        }                    }                }            } catch {                await MainActor.run {                    self.isLoadingClubs = false                    print("‚ùå Error loading user clubs: \(error)")                }            }        }    }}class ClubChatViewModel: ObservableObject {    let club: Club    @Published var messages: [ClubMessage] = []    @Published var isLoading = false        init(club: Club) {        self.club = club    }        func loadMessages() {        guard let clubId = club.objectId else { return }                isLoading = true                Task {            do {                let query = ClubMessage.query()                    .order([.ascending("createdAt")])                                let allMessages = try await query.find()                let clubMessages = allMessages.filter { $0.clubId == clubId }                                await MainActor.run {                    self.messages = clubMessages                    self.isLoading = false                    print("‚úÖ Loaded \(clubMessages.count) messages for club")                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("‚ùå Error loading messages: \(error)")                }            }        }    }        func sendMessage(text: String) {        guard let clubId = club.objectId,              let userId = User.current?.objectId,              let username = User.current?.username else {            print("‚ùå Missing required info to send message")            return        }                var message = ClubMessage()        message.clubId = clubId        message.userId = userId        message.username = username        message.text = text                Task {            do {                let savedMessage = try await message.save()                await MainActor.run {                    self.messages.append(savedMessage)                    print("‚úÖ Message sent")                }            } catch {                print("‚ùå Error sending message: \(error)")            }        }    }}#Preview {    MessagesView()}