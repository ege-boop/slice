import SwiftUIimport CoreLocationimport MapKitstruct DiscoverEventsView: View {    @StateObject private var viewModel = DiscoverEventsViewModel()    @State private var searchText = ""    @State private var showMap = false    @State private var selectedCategory: TMEventCategory?    @State private var region = MKCoordinateRegion(        center: CLLocationCoordinate2D(latitude: 37.7749, longitude: -122.4194),        span: MKCoordinateSpan(latitudeDelta: 0.5, longitudeDelta: 0.5)    )        var body: some View {        NavigationView {            VStack(spacing: 0) {                // Search Bar                HStack(spacing: 12) {                    HStack(spacing: 8) {                        Image(systemName: "magnifyingglass")                            .foregroundColor(.gray)                                                TextField("Search concerts, sports, shows...", text: $searchText)                            .onSubmit {                                if !searchText.isEmpty {                                    viewModel.searchEvents(query: searchText)                                }                            }                    }                    .padding(12)                    .background(Color.gray.opacity(0.1))                    .cornerRadius(12)                                        if !searchText.isEmpty {                        Button(action: {                            searchText = ""                            viewModel.loadEvents()                        }) {                            Image(systemName: "xmark.circle.fill")                                .foregroundColor(.gray)                        }                    }                }                .padding()                                // Category Filters                ScrollView(.horizontal, showsIndicators: false) {                    HStack(spacing: 12) {                        CategoryFilterButton(                            title: "All",                            icon: "star.fill",                            isSelected: selectedCategory == nil                        ) {                            selectedCategory = nil                            viewModel.filterByCategory(nil)                        }                                                ForEach(TMEventCategory.allCases, id: \.self) { category in                            CategoryFilterButton(                                title: category.rawValue,                                icon: category.icon,                                isSelected: selectedCategory == category                            ) {                                selectedCategory = category                                viewModel.filterByCategory(category)                            }                        }                    }                    .padding(.horizontal)                }                .padding(.bottom, 8)                                // Toggle between List and Map                HStack {                    Button(action: { showMap = false }) {                        HStack {                            Image(systemName: "list.bullet")                            Text("List")                        }                        .font(.system(size: 14, weight: .medium))                        .foregroundColor(showMap ? .gray : .white)                        .padding(.horizontal, 20)                        .padding(.vertical, 8)                        .background(showMap ? Color.clear : Color.black)                        .cornerRadius(8)                    }                                        Button(action: {                        showMap = true                        centerMapOnEvents()                    }) {                        HStack {                            Image(systemName: "map")                            Text("Map")                        }                        .font(.system(size: 14, weight: .medium))                        .foregroundColor(showMap ? .white : .gray)                        .padding(.horizontal, 20)                        .padding(.vertical, 8)                        .background(showMap ? Color.black : Color.clear)                        .cornerRadius(8)                    }                                        Spacer()                }                .padding(.horizontal)                .padding(.bottom, 8)                                Divider()                                // Content                if viewModel.isLoading {                    ProgressView()                        .padding(.top, 50)                    Spacer()                } else if viewModel.filteredEvents.isEmpty {                    VStack(spacing: 20) {                        Image(systemName: "ticket.fill")                            .font(.system(size: 60))                            .foregroundColor(.gray)                                                Text("No events found")                            .font(.system(size: 20, weight: .semibold))                                                Text(selectedCategory == nil ? "Try searching for concerts, sports, or comedy shows" : "No \(selectedCategory?.rawValue ?? "") events found")                            .font(.system(size: 14))                            .foregroundColor(.gray)                            .multilineTextAlignment(.center)                            .padding(.horizontal, 40)                    }                    .padding(.top, 50)                    Spacer()                } else {                    if showMap {                        // MAP VIEW with Zoom Controls                        ZStack(alignment: .bottomTrailing) {                            Map(coordinateRegion: $region, annotationItems: viewModel.filteredEvents.filter { $0.hasValidCoordinates }) { event in                                MapAnnotation(coordinate: event.coordinate) {                                    TMEventMapPin(event: event)                                }                            }                            .ignoresSafeArea(edges: .bottom)                                                        // Zoom Controls                            VStack(spacing: 12) {                                Button(action: {                                    zoomIn()                                }) {                                    Image(systemName: "plus")                                        .font(.system(size: 20, weight: .semibold))                                        .foregroundColor(.black)                                        .frame(width: 44, height: 44)                                        .background(Color.white)                                        .clipShape(Circle())                                        .shadow(radius: 4)                                }                                                                Button(action: {                                    zoomOut()                                }) {                                    Image(systemName: "minus")                                        .font(.system(size: 20, weight: .semibold))                                        .foregroundColor(.black)                                        .frame(width: 44, height: 44)                                        .background(Color.white)                                        .clipShape(Circle())                                        .shadow(radius: 4)                                }                                                                Button(action: {                                    centerMapOnEvents()                                }) {                                    Image(systemName: "location.fill")                                        .font(.system(size: 18, weight: .semibold))                                        .foregroundColor(.black)                                        .frame(width: 44, height: 44)                                        .background(Color.white)                                        .clipShape(Circle())                                        .shadow(radius: 4)                                }                            }                            .padding(.trailing, 16)                            .padding(.bottom, 100)                        }                    } else {                        // LIST VIEW                        ScrollView {                            LazyVStack(spacing: 20) {                                ForEach(viewModel.filteredEvents) { event in                                    TMEventCard(event: event)                                }                            }                            .padding()                        }                    }                }            }            .navigationTitle("Discover Events")        }        .onAppear {            viewModel.loadEvents()        }    }        func centerMapOnEvents() {        let validEvents = viewModel.filteredEvents.filter { $0.hasValidCoordinates }        guard !validEvents.isEmpty else { return }                let coordinates = validEvents.map { $0.coordinate }        let minLat = coordinates.map { $0.latitude }.min() ?? 0        let maxLat = coordinates.map { $0.latitude }.max() ?? 0        let minLon = coordinates.map { $0.longitude }.min() ?? 0        let maxLon = coordinates.map { $0.longitude }.max() ?? 0                let center = CLLocationCoordinate2D(            latitude: (minLat + maxLat) / 2,            longitude: (minLon + maxLon) / 2        )                let span = MKCoordinateSpan(            latitudeDelta: max(0.05, (maxLat - minLat) * 1.5),            longitudeDelta: max(0.05, (maxLon - minLon) * 1.5)        )                region = MKCoordinateRegion(center: center, span: span)    }        func zoomIn() {        region.span.latitudeDelta /= 2        region.span.longitudeDelta /= 2    }        func zoomOut() {        region.span.latitudeDelta *= 2        region.span.longitudeDelta *= 2    }}// Ticketmaster Event Categories (renamed to avoid conflicts)enum TMEventCategory: String, CaseIterable {    case music = "Music"    case sports = "Sports"    case arts = "Arts"    case family = "Family"    case comedy = "Comedy"    case theater = "Theater"        var icon: String {        switch self {        case .music: return "music.note"        case .sports: return "sportscourt"        case .arts: return "paintbrush"        case .family: return "figure.2.and.child.holdinghands"        case .comedy: return "face.smiling"        case .theater: return "theatermasks"        }    }}struct CategoryFilterButton: View {    let title: String    let icon: String    let isSelected: Bool    let action: () -> Void        var body: some View {        Button(action: action) {            HStack(spacing: 6) {                Image(systemName: icon)                    .font(.system(size: 12))                Text(title)                    .font(.system(size: 14, weight: .medium))            }            .foregroundColor(isSelected ? .white : .black)            .padding(.horizontal, 16)            .padding(.vertical, 8)            .background(isSelected ? Color.black : Color.gray.opacity(0.1))            .cornerRadius(20)        }    }}// Map Pin for Events// Map Pin for Events with IMAGEstruct TMEventMapPin: View {    let event: TMEventModel    @State private var showDetail = false        var body: some View {        Button(action: {            showDetail = true        }) {            VStack(spacing: 4) {                // Event Image or Icon                if let imageURL = event.imageURL, !imageURL.isEmpty, let url = URL(string: imageURL) {                    AsyncImage(url: url) { phase in                        switch phase {                        case .success(let image):                            image                                .resizable()                                .aspectRatio(contentMode: .fill)                                .frame(width: 60, height: 60)                                .clipShape(Circle())                                .overlay(                                    Circle()                                        .stroke(Color.white, lineWidth: 3)                                )                                .shadow(radius: 6)                        case .empty:                            Circle()                                .fill(Color.red)                                .frame(width: 60, height: 60)                                .overlay(ProgressView().tint(.white))                                .shadow(radius: 4)                        case .failure:                            ZStack {                                Circle()                                    .fill(Color.red)                                    .frame(width: 60, height: 60)                                    .shadow(radius: 4)                                                                Image(systemName: "ticket.fill")                                    .font(.system(size: 24))                                    .foregroundColor(.white)                            }                        @unknown default:                            ZStack {                                Circle()                                    .fill(Color.red)                                    .frame(width: 60, height: 60)                                    .shadow(radius: 4)                                                                Image(systemName: "ticket.fill")                                    .font(.system(size: 24))                                    .foregroundColor(.white)                            }                        }                    }                } else {                    // Fallback icon if no image                    ZStack {                        Circle()                            .fill(Color.red)                            .frame(width: 60, height: 60)                            .shadow(radius: 4)                                                Image(systemName: "ticket.fill")                            .font(.system(size: 24))                            .foregroundColor(.white)                    }                }                                // Event name label                Text(event.name)                    .font(.system(size: 10, weight: .bold))                    .foregroundColor(.black)                    .lineLimit(2)                    .multilineTextAlignment(.center)                    .frame(maxWidth: 120)                    .padding(.horizontal, 8)                    .padding(.vertical, 4)                    .background(                        RoundedRectangle(cornerRadius: 8)                            .fill(Color.white)                            .shadow(color: Color.black.opacity(0.2), radius: 4, x: 0, y: 2)                    )            }        }        .sheet(isPresented: $showDetail) {            TMEventDetailSheet(event: event)        }    }}struct TMEventCard: View {    let event: TMEventModel    @State private var showDetail = false        var body: some View {        Button(action: {            showDetail = true        }) {            VStack(spacing: 0) {                // Event Image                Group {                    if let imageURL = event.imageURL, !imageURL.isEmpty, let url = URL(string: imageURL) {                        AsyncImage(url: url) { phase in                            switch phase {                            case .success(let image):                                image                                    .resizable()                                    .aspectRatio(contentMode: .fill)                                    .frame(width: UIScreen.main.bounds.width - 40, height: 200)                                    .clipped()                            case .empty:                                Rectangle()                                    .fill(Color.gray.opacity(0.2))                                    .frame(height: 200)                                    .overlay(ProgressView())                            case .failure:                                Rectangle()                                    .fill(Color.orange.opacity(0.3))                                    .frame(height: 200)                                    .overlay(                                        Image(systemName: "photo")                                            .font(.system(size: 40))                                            .foregroundColor(.white)                                    )                            @unknown default:                                Rectangle()                                    .fill(Color.gray.opacity(0.2))                                    .frame(height: 200)                            }                        }                    } else {                        Rectangle()                            .fill(LinearGradient(                                colors: [Color.purple, Color.blue],                                startPoint: .topLeading,                                endPoint: .bottomTrailing                            ))                            .frame(height: 200)                            .overlay(                                Image(systemName: "ticket.fill")                                    .font(.system(size: 50))                                    .foregroundColor(.white)                            )                    }                }                .cornerRadius(16, corners: [.topLeft, .topRight])                                // Event Info                VStack(alignment: .leading, spacing: 12) {                    Text(event.name)                        .font(.system(size: 18, weight: .bold))                        .foregroundColor(.black)                        .lineLimit(2)                        .multilineTextAlignment(.leading)                        .frame(maxWidth: .infinity, alignment: .leading)                                        HStack(spacing: 8) {                        Image(systemName: "calendar")                            .font(.system(size: 14))                        Text(event.dateString)                            .font(.system(size: 14))                                                if let time = event.timeString {                            Text("‚Ä¢")                            Text(time)                                .font(.system(size: 14))                        }                    }                    .foregroundColor(.gray)                                        HStack(spacing: 8) {                        Image(systemName: "mappin.circle.fill")                            .font(.system(size: 14))                        VStack(alignment: .leading, spacing: 2) {                            Text(event.venueName)                                .font(.system(size: 14, weight: .medium))                                .lineLimit(1)                            if !event.venueCity.isEmpty {                                Text(event.venueCity)                                    .font(.system(size: 12))                                    .foregroundColor(.gray)                            }                        }                    }                    .foregroundColor(.black)                    .frame(maxWidth: .infinity, alignment: .leading)                                        // Price                    HStack(spacing: 8) {                        Image(systemName: "dollarsign.circle.fill")                            .font(.system(size: 14))                        if let price = event.priceRange {                            Text(price)                                .font(.system(size: 16, weight: .bold))                                .foregroundColor(.green)                        } else {                            Text("Price varies")                                .font(.system(size: 14))                                .foregroundColor(.gray)                        }                    }                                        // View Details Button                    HStack {                        Spacer()                        Text("View Details")                            .font(.system(size: 14, weight: .semibold))                        Image(systemName: "arrow.right")                            .font(.system(size: 12))                        Spacer()                    }                    .foregroundColor(.white)                    .padding(.vertical, 12)                    .background(Color.black)                    .cornerRadius(10)                }                .padding()            }            .background(Color.white)            .cornerRadius(16)            .shadow(color: Color.black.opacity(0.1), radius: 10, x: 0, y: 4)        }        .buttonStyle(PlainButtonStyle())        .sheet(isPresented: $showDetail) {            TMEventDetailSheet(event: event)        }    }}// Custom corner radiusextension View {    func cornerRadius(_ radius: CGFloat, corners: UIRectCorner) -> some View {        clipShape(RoundedCorner(radius: radius, corners: corners))    }}struct RoundedCorner: Shape {    var radius: CGFloat = .infinity    var corners: UIRectCorner = .allCorners        func path(in rect: CGRect) -> Path {        let path = UIBezierPath(            roundedRect: rect,            byRoundingCorners: corners,            cornerRadii: CGSize(width: radius, height: radius)        )        return Path(path.cgPath)    }}struct TMEventDetailSheet: View {    let event: TMEventModel    @Environment(\.dismiss) var dismiss    @State private var region: MKCoordinateRegion        init(event: TMEventModel) {        self.event = event        _region = State(initialValue: MKCoordinateRegion(            center: event.coordinate,            span: MKCoordinateSpan(latitudeDelta: 0.02, longitudeDelta: 0.02)        ))    }        var body: some View {        NavigationView {            ScrollView {                VStack(spacing: 0) {                    // Event Image                    if let imageURL = event.imageURL, !imageURL.isEmpty, let url = URL(string: imageURL) {                        AsyncImage(url: url) { phase in                            switch phase {                            case .success(let image):                                image                                    .resizable()                                    .aspectRatio(contentMode: .fill)                                    .frame(width: UIScreen.main.bounds.width, height: 300)                                    .clipped()                            case .empty:                                Rectangle()                                    .fill(Color.gray.opacity(0.2))                                    .frame(height: 300)                                    .overlay(ProgressView())                            case .failure:                                Rectangle()                                    .fill(LinearGradient(                                        colors: [Color.purple, Color.blue],                                        startPoint: .topLeading,                                        endPoint: .bottomTrailing                                    ))                                    .frame(height: 300)                            @unknown default:                                EmptyView()                            }                        }                    }                                        VStack(alignment: .leading, spacing: 24) {                        Text(event.name)                            .font(.system(size: 28, weight: .bold))                                                Divider()                                                // Date & Time                        HStack(spacing: 16) {                            ZStack {                                Circle()                                    .fill(Color.black.opacity(0.1))                                    .frame(width: 56, height: 56)                                Image(systemName: "calendar")                                    .font(.system(size: 24))                                    .foregroundColor(.black)                            }                                                        VStack(alignment: .leading, spacing: 4) {                                Text("Date & Time")                                    .font(.system(size: 13))                                    .foregroundColor(.gray)                                Text(event.dateString)                                    .font(.system(size: 17, weight: .semibold))                                if let time = event.timeString {                                    Text(time)                                        .font(.system(size: 15))                                        .foregroundColor(.gray)                                }                            }                        }                                                Divider()                                                // Venue                        HStack(spacing: 16) {                            ZStack {                                Circle()                                    .fill(Color.black.opacity(0.1))                                    .frame(width: 56, height: 56)                                Image(systemName: "mappin.circle.fill")                                    .font(.system(size: 24))                                    .foregroundColor(.black)                            }                                                        VStack(alignment: .leading, spacing: 4) {                                Text("Venue")                                    .font(.system(size: 13))                                    .foregroundColor(.gray)                                Text(event.venueName)                                    .font(.system(size: 17, weight: .semibold))                                if !event.venueCity.isEmpty {                                    Text(event.venueCity)                                        .font(.system(size: 15))                                        .foregroundColor(.gray)                                }                            }                        }                                                // Map                        if event.hasValidCoordinates {                            Map(coordinateRegion: .constant(region), annotationItems: [event]) { event in                                MapMarker(coordinate: event.coordinate, tint: .red)                            }                            .frame(height: 200)                            .cornerRadius(12)                            .allowsHitTesting(false)                        }                                                Divider()                                                // Price                        if let price = event.priceRange {                            HStack(spacing: 16) {                                ZStack {                                    Circle()                                        .fill(Color.green.opacity(0.1))                                        .frame(width: 56, height: 56)                                    Image(systemName: "dollarsign.circle.fill")                                        .font(.system(size: 24))                                        .foregroundColor(.green)                                }                                                                VStack(alignment: .leading, spacing: 4) {                                    Text("Price Range")                                        .font(.system(size: 13))                                        .foregroundColor(.gray)                                    Text(price)                                        .font(.system(size: 20, weight: .bold))                                        .foregroundColor(.green)                                }                            }                                                        Divider()                        }                                                // Get Tickets Button                        Link(destination: URL(string: event.url ?? "https://www.ticketmaster.com")!) {                            HStack {                                Spacer()                                Image(systemName: "ticket.fill")                                    .font(.system(size: 18))                                Text("Get Tickets on Ticketmaster")                                    .font(.system(size: 17, weight: .semibold))                                Spacer()                            }                            .foregroundColor(.white)                            .padding(.vertical, 18)                            .background(                                LinearGradient(                                    colors: [Color.blue, Color.purple],                                    startPoint: .leading,                                    endPoint: .trailing                                )                            )                            .cornerRadius(14)                            .shadow(color: Color.blue.opacity(0.3), radius: 10, x: 0, y: 5)                        }                    }                    .padding()                }            }            .navigationBarTitleDisplayMode(.inline)            .toolbar {                ToolbarItem(placement: .navigationBarTrailing) {                    Button(action: {                        dismiss()                    }) {                        Image(systemName: "xmark.circle.fill")                            .font(.system(size: 24))                            .foregroundColor(.gray)                    }                }            }        }    }}class DiscoverEventsViewModel: ObservableObject {    @Published var events: [TMEventModel] = []    @Published var filteredEvents: [TMEventModel] = []    @Published var isLoading = false    private var selectedCategory: TMEventCategory?        func loadEvents() {        isLoading = true        selectedCategory = nil                Task {            do {                // Changed: Load worldwide events instead of location-based                let fetchedEvents = try await TicketmasterService.shared.fetchEventsWorldwide()                                await MainActor.run {                    print("üì¶ Loaded \(fetchedEvents.count) worldwide events")                    self.events = fetchedEvents                    self.filteredEvents = fetchedEvents                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("‚ùå Error loading events: \(error)")                }            }        }    }        func searchEvents(query: String) {        isLoading = true                Task {            do {                let fetchedEvents = try await TicketmasterService.shared.searchEvents(keyword: query)                                await MainActor.run {                    self.events = fetchedEvents                    self.filteredEvents = fetchedEvents                    self.selectedCategory = nil                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("‚ùå Error searching events: \(error)")                }            }        }    }        func filterByCategory(_ category: TMEventCategory?) {        selectedCategory = category                guard let category = category else {            filteredEvents = events            print("üîç Showing all \(events.count) events")            return        }                isLoading = true                Task {            do {                // Changed: Fetch worldwide category events                let fetchedEvents = try await TicketmasterService.shared.fetchEventsByCategory(category: category.rawValue)                                await MainActor.run {                    print("üîç Found \(fetchedEvents.count) \(category.rawValue) events")                    self.filteredEvents = fetchedEvents                    self.isLoading = false                }            } catch {                await MainActor.run {                    print("‚ùå Error filtering by category: \(error)")                    self.filteredEvents = self.events.filter { event in                        event.name.localizedCaseInsensitiveContains(category.rawValue) ||                        event.categoryName?.localizedCaseInsensitiveContains(category.rawValue) ?? false                    }                    self.isLoading = false                }            }        }    }}#Preview {    DiscoverEventsView()}