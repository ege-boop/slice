//
//  ClubProfileView.swift
//  FinalProject
//
//  Created by Ahmet Aytac on 11/10/25.
//


import SwiftUIimport MapKitstruct ClubProfileView: View {    let club: Club    @StateObject private var viewModel: ClubProfileViewModel    @Environment(\.dismiss) var dismiss        init(club: Club) {        self.club = club        _viewModel = StateObject(wrappedValue: ClubProfileViewModel(club: club))    }        var body: some View {        ScrollView {            VStack(spacing: 0) {                // Header Image / Cover                Rectangle()                    .fill(                        LinearGradient(                            colors: [Color.black, Color.gray],                            startPoint: .topLeading,                            endPoint: .bottomTrailing                        )                    )                    .frame(height: 200)                    .overlay(                        VStack {                            Spacer()                                                        // Club Icon                            Circle()                                .fill(Color.white)                                .frame(width: 100, height: 100)                                .overlay(                                    Text(club.name?.prefix(1).uppercased() ?? "C")                                        .font(.system(size: 40, weight: .bold))                                        .foregroundColor(.black)                                )                                .offset(y: 50)                        }                    )                                // Club Info                VStack(spacing: 20) {                    VStack(spacing: 8) {                        Text(club.name ?? "Club")                            .font(.system(size: 28, weight: .bold))                            .padding(.top, 60)                                                if let category = club.category {                            Text(category)                                .font(.system(size: 14))                                .foregroundColor(.white)                                .padding(.horizontal, 16)                                .padding(.vertical, 6)                                .background(Color.black)                                .cornerRadius(20)                        }                    }                                        // Description                    if let description = club.description, !description.isEmpty {                        Text(description)                            .font(.system(size: 15))                            .foregroundColor(.gray)                            .multilineTextAlignment(.center)                            .padding(.horizontal, 40)                    }                                        // Stats                    HStack(spacing: 40) {                        VStack(spacing: 4) {                            Text("\(club.memberCount ?? 0)")                                .font(.system(size: 22, weight: .bold))                            Text("Members")                                .font(.system(size: 12))                                .foregroundColor(.gray)                        }                                                VStack(spacing: 4) {                            Text("\(viewModel.posts.count)")                                .font(.system(size: 22, weight: .bold))                            Text("Posts")                                .font(.system(size: 12))                                .foregroundColor(.gray)                        }                                                VStack(spacing: 4) {                            Text(club.privacy ?? "Public")                                .font(.system(size: 22, weight: .bold))                            Text("Privacy")                                .font(.system(size: 12))                                .foregroundColor(.gray)                        }                    }                    .padding()                    .background(Color.gray.opacity(0.1))                    .cornerRadius(12)                    .padding(.horizontal)                                        // Join/Leave Button                    if viewModel.isMember {                        Button(action: {                            viewModel.leaveClub()                        }) {                            if viewModel.isLoading {                                ProgressView()                                    .progressViewStyle(CircularProgressViewStyle(tint: .black))                            } else {                                HStack {                                    Image(systemName: "person.badge.minus")                                    Text("Leave Club")                                        .font(.system(size: 16, weight: .semibold))                                }                                .foregroundColor(.black)                            }                        }                        .frame(maxWidth: .infinity)                        .padding(.vertical, 14)                        .background(Color.gray.opacity(0.2))                        .cornerRadius(12)                        .padding(.horizontal)                        .disabled(viewModel.isLoading)                    } else {                        Button(action: {                            viewModel.joinClub()                        }) {                            if viewModel.isLoading {                                ProgressView()                                    .progressViewStyle(CircularProgressViewStyle(tint: .white))                            } else {                                HStack {                                    Image(systemName: "person.badge.plus")                                    Text("Join Club")                                        .font(.system(size: 16, weight: .semibold))                                }                                .foregroundColor(.white)                            }                        }                        .frame(maxWidth: .infinity)                        .padding(.vertical, 14)                        .background(Color.black)                        .cornerRadius(12)                        .padding(.horizontal)                        .disabled(viewModel.isLoading)                    }                                        Divider()                                        // Location                    if let address = club.address {                        VStack(alignment: .leading, spacing: 12) {                            HStack {                                Image(systemName: "mappin.circle.fill")                                    .foregroundColor(.black)                                Text("Location")                                    .font(.system(size: 18, weight: .semibold))                            }                                                        Text(address)                                .font(.system(size: 14))                                .foregroundColor(.gray)                                                        // Mini Map                            Map(coordinateRegion: .constant(MKCoordinateRegion(                                center: club.coordinate,                                span: MKCoordinateSpan(latitudeDelta: 0.01, longitudeDelta: 0.01)                            )), annotationItems: [club]) { club in                                MapPin(coordinate: club.coordinate, tint: .red)                            }                            .frame(height: 150)                            .cornerRadius(12)                            .disabled(true)                        }                        .padding()                        .background(Color.gray.opacity(0.05))                        .cornerRadius(12)                        .padding(.horizontal)                    }                                        Divider()                                        // Members Section                    VStack(alignment: .leading, spacing: 16) {                        Text("Members")                            .font(.system(size: 20, weight: .bold))                            .padding(.horizontal)                                                if viewModel.isLoadingMembers {                            ProgressView()                                .padding()                        } else if viewModel.members.isEmpty {                            Text("No members yet")                                .font(.system(size: 14))                                .foregroundColor(.gray)                                .frame(maxWidth: .infinity)                                .padding()                        } else {                            ScrollView(.horizontal, showsIndicators: false) {                                HStack(spacing: 16) {                                    ForEach(viewModel.members, id: \.objectId) { member in                                        VStack(spacing: 8) {                                            Circle()                                                .fill(Color.black)                                                .frame(width: 60, height: 60)                                                .overlay(                                                    Text(member.username?.prefix(1).uppercased() ?? "?")                                                        .font(.system(size: 24, weight: .bold))                                                        .foregroundColor(.white)                                                )                                                                                        Text(member.username ?? "User")                                                .font(.system(size: 12))                                                .lineLimit(1)                                        }                                        .frame(width: 80)                                    }                                }                                .padding(.horizontal)                            }                        }                    }                                        Divider()                                        // Club Posts                    VStack(alignment: .leading, spacing: 16) {                        Text("Club Posts")                            .font(.system(size: 20, weight: .bold))                            .padding(.horizontal)                                                if viewModel.posts.isEmpty {                            VStack(spacing: 16) {                                Image(systemName: "photo.on.rectangle")                                    .font(.system(size: 50))                                    .foregroundColor(.gray)                                Text("No posts yet")                                    .font(.system(size: 16))                                    .foregroundColor(.gray)                            }                            .frame(maxWidth: .infinity)                            .padding(.vertical, 40)                        } else {                            LazyVGrid(columns: [                                GridItem(.flexible()),                                GridItem(.flexible()),                                GridItem(.flexible())                            ], spacing: 2) {                                ForEach(viewModel.posts) { post in                                    if let imageURL = post.imageURL, let url = URL(string: imageURL) {                                        AsyncImage(url: url) { phase in                                            switch phase {                                            case .success(let image):                                                image                                                    .resizable()                                                    .scaledToFill()                                                    .aspectRatio(1, contentMode: .fill)                                                    .clipped()                                            case .empty, .failure:                                                Rectangle()                                                    .fill(Color.gray.opacity(0.2))                                                    .aspectRatio(1, contentMode: .fit)                                            @unknown default:                                                EmptyView()                                            }                                        }                                    }                                }                            }                        }                    }                }            }        }        .navigationBarTitleDisplayMode(.inline)        .onAppear {            viewModel.loadData()        }    }}class ClubProfileViewModel: ObservableObject {    let club: Club    @Published var isMember = false    @Published var isLoading = false    @Published var isLoadingMembers = false    @Published var members: [User] = []    @Published var posts: [Post] = []        init(club: Club) {        self.club = club    }        func loadData() {        checkMembership()        loadMembers()        loadPosts()    }        func checkMembership() {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                Task {            do {                let member = try await ParseService.shared.checkMembership(userId: userId, clubId: clubId)                await MainActor.run {                    self.isMember = member                }            } catch {                print("Error checking membership: \(error)")            }        }    }        func joinClub() {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                isLoading = true                Task {            do {                try await ParseService.shared.joinClub(userId: userId, clubId: clubId)                await MainActor.run {                    self.isMember = true                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error joining club: \(error)")                }            }        }    }        func leaveClub() {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                isLoading = true                Task {            do {                try await ParseService.shared.leaveClub(userId: userId, clubId: clubId)                await MainActor.run {                    self.isMember = false                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error leaving club: \(error)")                }            }        }    }        func loadMembers() {        guard let clubId = club.objectId else { return }                isLoadingMembers = true                Task {            do {                // Get all members for this club                let allMembers = try await Member.query().find()                let clubMemberIds = allMembers                    .filter { $0.clubId == clubId }                    .compactMap { $0.userId }                                // Get user details                let allUsers = try await User.query().find()                let clubMembers = allUsers.filter { user in                    guard let userId = user.objectId else { return false }                    return clubMemberIds.contains(userId)                }                                await MainActor.run {                    self.members = clubMembers                    self.isLoadingMembers = false                }            } catch {                await MainActor.run {                    self.isLoadingMembers = false                    print("Error loading members: \(error)")                }            }        }    }        func loadPosts() {        // Load posts related to this club (if you implement club posts later)        // For now, empty    }}#Preview {    NavigationView {        ClubProfileView(club: Club())    }}