////  UserSearchView.swift//  FinalProject////  Enhanced User Search with @ username support//import SwiftUIstruct UserSearchView: View {    @StateObject private var viewModel = UserSearchViewModel()    @State private var searchText = ""    @State private var showSuggestions = true        var body: some View {        NavigationView {            VStack(spacing: 0) {                // Search Bar                HStack(spacing: 12) {                    Image(systemName: "magnifyingglass")                        .foregroundColor(.gray)                                        TextField("Search @username or name...", text: $searchText)                        .textFieldStyle(PlainTextFieldStyle())                        .autocapitalization(.none)                        .onChange(of: searchText) { oldValue, newValue in                            if searchText.isEmpty {                                viewModel.users = []                                showSuggestions = true                            } else {                                showSuggestions = false                                viewModel.searchUsers(query: searchText)                            }                        }                                        if !searchText.isEmpty {                        Button(action: {                            searchText = ""                            viewModel.users = []                            showSuggestions = true                        }) {                            Image(systemName: "xmark.circle.fill")                                .foregroundColor(.gray)                        }                    }                }                .padding()                .background(Color.gray.opacity(0.1))                                Divider()                                // Search Tips (when search bar is empty)                if searchText.isEmpty && showSuggestions {                    ScrollView {                        VStack(alignment: .leading, spacing: 24) {                            // Search Tips                            VStack(alignment: .leading, spacing: 12) {                                Text("Search Tips")                                    .font(.system(size: 18, weight: .bold))                                    .padding(.horizontal)                                                                VStack(spacing: 12) {                                    SearchTipRow(                                        icon: "at",                                        title: "Search by username",                                        example: "@johnsmith"                                    )                                    SearchTipRow(                                        icon: "person.fill",                                        title: "Search by name",                                        example: "John Smith"                                    )                                    SearchTipRow(                                        icon: "magnifyingglass",                                        title: "Partial search works too",                                        example: "john"                                    )                                }                                .padding(.horizontal)                            }                            .padding(.top, 20)                                                        Divider()                                                        // Suggested Users                            VStack(alignment: .leading, spacing: 16) {                                HStack {                                    Text("Suggested for You")                                        .font(.system(size: 18, weight: .bold))                                    Spacer()                                    Button("Refresh") {                                        viewModel.loadSuggestedUsers()                                    }                                    .font(.system(size: 14))                                    .foregroundColor(.blue)                                }                                .padding(.horizontal)                                                                if viewModel.isLoadingSuggestions {                                    ProgressView()                                        .frame(maxWidth: .infinity)                                        .padding()                                } else if viewModel.suggestedUsers.isEmpty {                                    Text("No suggestions available")                                        .foregroundColor(.gray)                                        .padding()                                } else {                                    ScrollView(.horizontal, showsIndicators: false) {                                        HStack(spacing: 16) {                                            ForEach(viewModel.suggestedUsers, id: \.objectId) { user in                                                NavigationLink(destination: UserProfileView(user: user)) {                                                    SuggestedUserCard(user: user)                                                }                                                .buttonStyle(PlainButtonStyle())                                            }                                        }                                        .padding(.horizontal)                                    }                                }                            }                        }                    }                }                // Search Results                else if viewModel.isSearching {                    ProgressView()                        .padding(.top, 40)                    Spacer()                } else if viewModel.users.isEmpty && !searchText.isEmpty {                    VStack(spacing: 16) {                        Image(systemName: "person.slash")                            .font(.system(size: 60))                            .foregroundColor(.gray)                        Text("No users found")                            .font(.system(size: 18))                            .foregroundColor(.gray)                        Text("Try searching with @username")                            .font(.system(size: 14))                            .foregroundColor(.gray)                    }                    .padding(.top, 100)                    Spacer()                } else if !viewModel.users.isEmpty {                    ScrollView {                        LazyVStack(spacing: 0) {                            ForEach(viewModel.users, id: \.objectId) { user in                                NavigationLink(destination: UserProfileView(user: user)) {                                    EnhancedUserRow(user: user)                                }                                .buttonStyle(PlainButtonStyle())                                Divider().padding(.leading, 80)                            }                        }                    }                }            }            .navigationTitle("Search")        }        .onAppear {            if showSuggestions {                viewModel.loadSuggestedUsers()            }        }    }}struct SearchTipRow: View {    let icon: String    let title: String    let example: String        var body: some View {        HStack(spacing: 16) {            Image(systemName: icon)                .font(.system(size: 20))                .foregroundColor(.black)                .frame(width: 32, height: 32)                .background(Color.black.opacity(0.05))                .cornerRadius(8)                        VStack(alignment: .leading, spacing: 4) {                Text(title)                    .font(.system(size: 15, weight: .medium))                    .foregroundColor(.black)                Text(example)                    .font(.system(size: 13))                    .foregroundColor(.gray)            }                        Spacer()        }        .padding()        .background(Color.gray.opacity(0.05))        .cornerRadius(12)    }}struct SuggestedUserCard: View {    let user: User        var body: some View {        VStack(spacing: 12) {            Circle()                .fill(Color.black)                .frame(width: 80, height: 80)                .overlay(                    Text(user.username?.prefix(1).uppercased() ?? "?")                        .font(.system(size: 32, weight: .bold))                        .foregroundColor(.white)                )                        VStack(spacing: 4) {                Text("@\(user.username ?? "user")")                    .font(.system(size: 15, weight: .semibold))                    .foregroundColor(.black)                                if let displayName = user.displayName {                    Text(displayName)                        .font(.system(size: 13))                        .foregroundColor(.gray)                        .lineLimit(1)                }                                Text("\(user.followersCount ?? 0) followers")                    .font(.system(size: 12))                    .foregroundColor(.gray)            }        }        .frame(width: 140)        .padding()        .background(Color.white)        .cornerRadius(16)        .shadow(color: Color.black.opacity(0.1), radius: 8, y: 4)    }}struct EnhancedUserRow: View {    let user: User        var body: some View {        HStack(spacing: 16) {            Circle()                .fill(Color.black)                .frame(width: 56, height: 56)                .overlay(                    Text(user.username?.prefix(1).uppercased() ?? "?")                        .font(.system(size: 24, weight: .bold))                        .foregroundColor(.white)                )                        VStack(alignment: .leading, spacing: 4) {                HStack(spacing: 6) {                    Text("@\(user.username ?? "user")")                        .font(.system(size: 16, weight: .semibold))                        .foregroundColor(.black)                                        if user.isVerified == true {                        Image(systemName: "checkmark.seal.fill")                            .font(.system(size: 14))                            .foregroundColor(.blue)                    }                }                                if let displayName = user.displayName, displayName != user.username {                    Text(displayName)                        .font(.system(size: 14))                        .foregroundColor(.gray)                }                                if let bio = user.bio, !bio.isEmpty {                    Text(bio)                        .font(.system(size: 13))                        .foregroundColor(.gray)                        .lineLimit(1)                }                                HStack(spacing: 12) {                    Text("\(user.followersCount ?? 0) followers")                        .font(.system(size: 12))                        .foregroundColor(.gray)                                        Text("\(user.postsCount ?? 0) posts")                        .font(.system(size: 12))                        .foregroundColor(.gray)                }            }                        Spacer()                        Image(systemName: "chevron.right")                .foregroundColor(.gray)        }        .padding()    }}class UserSearchViewModel: ObservableObject {    @Published var users: [User] = []    @Published var suggestedUsers: [User] = []    @Published var isSearching = false    @Published var isLoadingSuggestions = false        func searchUsers(query: String) {        isSearching = true                Task {            do {                print("üîç Searching for: '\(query)'")                                // First, get all users to see what we have                let allUsers = try await User.query().find()                print("üìä Total users in database: \(allUsers.count)")                                // Print all users for debugging                for user in allUsers {                    print("üë§ User: @\(user.username ?? "nil")")                    print("   - usernameTag: \(user.usernameTag ?? "nil")")                    print("   - searchableName: \(user.searchableName ?? "nil")")                    print("   - displayName: \(user.displayName ?? "nil")")                }                                let results = try await SocialService.shared.searchUsers(query: query)                print("‚úÖ Found \(results.count) matching users")                                await MainActor.run {                    // Filter out current user                    self.users = results.filter { $0.objectId != User.current?.objectId }                    self.isSearching = false                    print("üì± Showing \(self.users.count) users (excluding current user)")                }            } catch {                await MainActor.run {                    self.isSearching = false                    print("‚ùå Error searching users: \(error)")                }            }        }    }        func loadSuggestedUsers() {        isLoadingSuggestions = true                Task {            do {                let suggestions = try await SocialService.shared.getSuggestedUsers(limit: 10)                await MainActor.run {                    self.suggestedUsers = suggestions                    self.isLoadingSuggestions = false                }            } catch {                await MainActor.run {                    self.isLoadingSuggestions = false                    print("Error loading suggestions: \(error)")                }            }        }    }}#Preview {    UserSearchView()}