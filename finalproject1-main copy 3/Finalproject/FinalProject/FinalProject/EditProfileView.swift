////  EditProfileView.swift//  FinalProject////  Created by Ahmet Aytac on 11/10/25.//import SwiftUIimport PhotosUIimport ParseSwiftstruct EditProfileView: View {    @Environment(\.dismiss) var dismiss    @StateObject private var viewModel = EditProfileViewModel()        var body: some View {        NavigationView {            ScrollView {                VStack(spacing: 24) {                    // Profile Picture Editor                    VStack(spacing: 16) {                        if let image = viewModel.selectedImage {                            Image(uiImage: image)                                .resizable()                                .scaledToFill()                                .frame(width: 120, height: 120)                                .clipShape(Circle())                        } else if let imageURL = viewModel.currentUser?.profileImageURL,                                  let url = URL(string: imageURL) {                            AsyncImage(url: url) { phase in                                switch phase {                                case .success(let image):                                    image                                        .resizable()                                        .scaledToFill()                                        .frame(width: 120, height: 120)                                        .clipShape(Circle())                                case .empty, .failure:                                    Circle()                                        .fill(Color.black)                                        .frame(width: 120, height: 120)                                        .overlay(                                            Text(viewModel.currentUser?.username?.prefix(1).uppercased() ?? "?")                                                .font(.system(size: 50, weight: .bold))                                                .foregroundColor(.white)                                        )                                @unknown default:                                    EmptyView()                                }                            }                        } else {                            Circle()                                .fill(Color.black)                                .frame(width: 120, height: 120)                                .overlay(                                    Text(viewModel.currentUser?.username?.prefix(1).uppercased() ?? "?")                                        .font(.system(size: 50, weight: .bold))                                        .foregroundColor(.white)                                )                        }                                                Button(action: {                            viewModel.showImagePicker = true                        }) {                            Text("Change Profile Picture")                                .font(.system(size: 14, weight: .semibold))                                .foregroundColor(.blue)                        }                    }                    .padding(.top, 20)                                        // Username (Read-only)                    VStack(alignment: .leading, spacing: 8) {                        Text("Username")                            .font(.system(size: 14, weight: .semibold))                            .foregroundColor(.gray)                                                Text(viewModel.currentUser?.username ?? "")                            .font(.system(size: 16))                            .padding(14)                            .frame(maxWidth: .infinity, alignment: .leading)                            .background(Color.gray.opacity(0.1))                            .cornerRadius(12)                    }                                        // Bio Editor                    VStack(alignment: .leading, spacing: 8) {                        Text("Bio")                            .font(.system(size: 14, weight: .semibold))                            .foregroundColor(.gray)                                                TextEditor(text: $viewModel.bio)                            .frame(height: 100)                            .padding(8)                            .background(Color.gray.opacity(0.1))                            .cornerRadius(12)                    }                                        // Error Message                    if !viewModel.errorMessage.isEmpty {                        Text(viewModel.errorMessage)                            .font(.system(size: 14))                            .foregroundColor(.red)                    }                                        Spacer()                }                .padding()            }            .navigationTitle("Edit Profile")            .navigationBarTitleDisplayMode(.inline)            .toolbar {                ToolbarItem(placement: .navigationBarLeading) {                    Button("Cancel") {                        dismiss()                    }                }                                ToolbarItem(placement: .navigationBarTrailing) {                    Button("Save") {                        viewModel.saveProfile {                            dismiss()                        }                    }                    .disabled(viewModel.isSaving)                }            }            .sheet(isPresented: $viewModel.showImagePicker) {                ImagePicker(image: $viewModel.selectedImage)            }        }    }}class EditProfileViewModel: ObservableObject {    @Published var currentUser: User?    @Published var bio = ""    @Published var selectedImage: UIImage?    @Published var showImagePicker = false    @Published var isSaving = false    @Published var errorMessage = ""        init() {        currentUser = User.current        bio = currentUser?.bio ?? ""    }        func saveProfile(completion: @escaping () -> Void) {        guard var user = User.current else {            errorMessage = "User not logged in"            return        }                isSaving = true        errorMessage = ""                Task {            do {                // Upload profile image if changed                if let image = selectedImage {                    guard let imageData = image.jpegData(compressionQuality: 0.7) else {                        throw NSError(domain: "EditProfile", code: 400, userInfo: [NSLocalizedDescriptionKey: "Failed to process image"])                    }                                        let parseFile = ParseFile(name: "profile_\(user.objectId ?? UUID().uuidString).jpg", data: imageData)                    let savedFile = try await parseFile.save()                                        user.profileImageURL = savedFile.url?.absoluteString                }                                // Update bio                user.bio = bio.isEmpty ? nil : bio                                // Save user                let updatedUser = try await user.save()                                await MainActor.run {                    self.currentUser = updatedUser                    self.isSaving = false                    completion()                }            } catch {                await MainActor.run {                    self.isSaving = false                    self.errorMessage = "Failed to update profile: \(error.localizedDescription)"                    print("Error updating profile: \(error)")                }            }        }    }}#Preview {    EditProfileView()}