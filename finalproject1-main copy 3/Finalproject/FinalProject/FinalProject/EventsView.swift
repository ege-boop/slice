////  EventsView.swift//  FinalProject////  Created by Ahmet Aytac on 11/16/25.//////  EventsView.swift//  FinalProject////  Complete Events Feature//import SwiftUIimport MapKitstruct EventsView: View {    @StateObject private var viewModel = EventsViewModel()    @State private var searchText = ""    @State private var selectedCategory: EventCategory?    @State private var showCreateEvent = false    @State private var selectedTab: EventTab = .discover        enum EventTab {        case discover        case myEvents        case attending    }        var body: some View {        NavigationView {            VStack(spacing: 0) {                // Custom Tab Bar                HStack(spacing: 0) {                    TabButton(title: "Discover", icon: "sparkles", isSelected: selectedTab == .discover) {                        selectedTab = .discover                    }                    TabButton(title: "My Events", icon: "calendar.badge.plus", isSelected: selectedTab == .myEvents) {                        selectedTab = .myEvents                        viewModel.loadMyEvents()                    }                    TabButton(title: "Attending", icon: "checkmark.seal.fill", isSelected: selectedTab == .attending) {                        selectedTab = .attending                        viewModel.loadAttendingEvents()                    }                }                .padding(.horizontal)                .padding(.top, 8)                                Divider()                                // Content based on selected tab                if selectedTab == .discover {                    discoverView                } else if selectedTab == .myEvents {                    myEventsView                } else {                    attendingEventsView                }            }            .navigationTitle("Events")            .toolbar {                ToolbarItem(placement: .navigationBarTrailing) {                    Button(action: { showCreateEvent = true }) {                        Image(systemName: "plus.circle.fill")                            .font(.system(size: 24))                            .foregroundColor(.black)                    }                }            }            .sheet(isPresented: $showCreateEvent) {                CreateEventView()            }        }        .onAppear {            if selectedTab == .discover {                viewModel.loadAllEvents()            }        }    }            var discoverView: some View {        VStack(spacing: 0) {            // Search Bar            HStack(spacing: 12) {                HStack(spacing: 8) {                    Image(systemName: "magnifyingglass")                        .foregroundColor(.gray)                                        TextField("Search events...", text: $searchText)                        .onChange(of: searchText) {                            if searchText.isEmpty {                                viewModel.loadAllEvents()                            } else {                                viewModel.searchEvents(query: searchText)                            }                        }                }                .padding(12)                .background(Color.black.opacity(0.05))                .cornerRadius(12)                                if !searchText.isEmpty {                    Button(action: {                        searchText = ""                        viewModel.loadAllEvents()                    }) {                        Image(systemName: "xmark.circle.fill")                            .foregroundColor(.gray)                    }                }            }            .padding()                        // Category Filters            ScrollView(.horizontal, showsIndicators: false) {                HStack(spacing: 12) {                    CategoryChip(title: "All", isSelected: selectedCategory == nil) {                        selectedCategory = nil                        viewModel.loadAllEvents()                    }                                        ForEach(EventCategory.allCases, id: \.self) { category in                        CategoryChip(title: category.rawValue, isSelected: selectedCategory == category) {                            selectedCategory = category                            viewModel.filterByCategory(category)                        }                    }                }                .padding(.horizontal)            }            .padding(.bottom)                        Divider()                        // Events List            if viewModel.isLoading {                ProgressView()                    .padding(.top, 50)                Spacer()            } else if viewModel.events.isEmpty {                emptyStateView            } else {                ScrollView {                    LazyVStack(spacing: 16) {                        ForEach(viewModel.events) { event in                            NavigationLink(destination: EventDetailView(event: event)) {                                EventCard(event: event)                            }                            .buttonStyle(PlainButtonStyle())                        }                    }                    .padding()                }            }        }    }            var myEventsView: some View {        Group {            if viewModel.isLoading {                ProgressView()                    .padding(.top, 50)                Spacer()            } else if viewModel.myEvents.isEmpty {                VStack(spacing: 20) {                    Image(systemName: "calendar.badge.plus")                        .font(.system(size: 60))                        .foregroundColor(.gray)                    Text("No Events Created")                        .font(.system(size: 20, weight: .semibold))                    Text("Create your first event to get started")                        .foregroundColor(.gray)                    Button("Create Event") {                        showCreateEvent = true                    }                    .padding()                    .background(Color.black)                    .foregroundColor(.white)                    .cornerRadius(12)                }                .padding(.top, 80)                Spacer()            } else {                ScrollView {                    LazyVStack(spacing: 16) {                        ForEach(viewModel.myEvents) { event in                            NavigationLink(destination: EventDetailView(event: event)) {                                EventCard(event: event, showHostBadge: true)                            }                            .buttonStyle(PlainButtonStyle())                        }                    }                    .padding()                }            }        }    }            var attendingEventsView: some View {        Group {            if viewModel.isLoading {                ProgressView()                    .padding(.top, 50)                Spacer()            } else if viewModel.attendingEvents.isEmpty {                VStack(spacing: 20) {                    Image(systemName: "ticket")                        .font(.system(size: 60))                        .foregroundColor(.gray)                    Text("No Events Yet")                        .font(.system(size: 20, weight: .semibold))                    Text("RSVP to events to see them here")                        .foregroundColor(.gray)                }                .padding(.top, 80)                Spacer()            } else {                ScrollView {                    LazyVStack(spacing: 16) {                        ForEach(viewModel.attendingEvents) { event in                            NavigationLink(destination: EventDetailView(event: event)) {                                EventCard(event: event, showGoingBadge: true)                            }                            .buttonStyle(PlainButtonStyle())                        }                    }                    .padding()                }            }        }    }        var emptyStateView: some View {        VStack(spacing: 20) {            Image(systemName: "calendar.badge.exclamationmark")                .font(.system(size: 60))                .foregroundColor(.gray)            Text("No Events Found")                .font(.system(size: 20, weight: .semibold))            Button("Create First Event") {                showCreateEvent = true            }            .padding()            .background(Color.black)            .foregroundColor(.white)            .cornerRadius(10)        }        .padding(.top, 80)    }}struct TabButton: View {    let title: String    let icon: String    let isSelected: Bool    let action: () -> Void        var body: some View {        Button(action: action) {            VStack(spacing: 8) {                Image(systemName: icon)                    .font(.system(size: 20))                Text(title)                    .font(.system(size: 13, weight: .medium))            }            .foregroundColor(isSelected ? .white : .black)            .frame(maxWidth: .infinity)            .padding(.vertical, 12)            .background(isSelected ? Color.black : Color.clear)            .cornerRadius(10)        }    }}struct CategoryChip: View {    let title: String    let isSelected: Bool    let action: () -> Void        var body: some View {        Button(action: action) {            Text(title)                .font(.system(size: 14, weight: .medium))                .foregroundColor(isSelected ? .white : .black)                .padding(.horizontal, 16)                .padding(.vertical, 8)                .background(isSelected ? Color.black : Color.black.opacity(0.05))                .cornerRadius(20)        }    }}struct EventCard: View {    let event: Event    var showHostBadge: Bool = false    var showGoingBadge: Bool = false        var body: some View {        VStack(alignment: .leading, spacing: 0) {            // Image            if let imageURL = event.imageURL, let url = URL(string: imageURL) {                AsyncImage(url: url) { phase in                    switch phase {                    case .success(let image):                        image                            .resizable()                            .scaledToFill()                            .frame(height: 200)                            .clipped()                    case .empty:                        Rectangle()                            .fill(Color.gray.opacity(0.2))                            .frame(height: 200)                            .overlay(ProgressView())                    case .failure:                        Rectangle()                            .fill(LinearGradient(colors: [Color.purple, Color.blue], startPoint: .topLeading, endPoint: .bottomTrailing))                            .frame(height: 200)                    @unknown default:                        EmptyView()                    }                }            } else {                Rectangle()                    .fill(LinearGradient(colors: [Color.purple, Color.blue], startPoint: .topLeading, endPoint: .bottomTrailing))                    .frame(height: 200)                    .overlay(                        Image(systemName: "calendar")                            .font(.system(size: 50))                            .foregroundColor(.white)                    )            }                        // Content            VStack(alignment: .leading, spacing: 12) {                // Date Badge                if let eventDate = event.eventDate {                    HStack(spacing: 8) {                        Image(systemName: "calendar")                            .font(.system(size: 14))                        Text(formatEventDate(eventDate))                            .font(.system(size: 14, weight: .semibold))                                                Spacer()                                                if showHostBadge {                            Text("HOST")                                .font(.system(size: 10, weight: .bold))                                .foregroundColor(.white)                                .padding(.horizontal, 8)                                .padding(.vertical, 4)                                .background(Color.purple)                                .cornerRadius(8)                        } else if showGoingBadge {                            Text("GOING")                                .font(.system(size: 10, weight: .bold))                                .foregroundColor(.white)                                .padding(.horizontal, 8)                                .padding(.vertical, 4)                                .background(Color.green)                                .cornerRadius(8)                        }                    }                    .foregroundColor(.gray)                }                                // Title                Text(event.title ?? "Event")                    .font(.system(size: 20, weight: .bold))                    .foregroundColor(.black)                                // Category & Location                HStack(spacing: 12) {                    if let category = event.category {                        HStack(spacing: 4) {                            Image(systemName: "tag.fill")                                .font(.system(size: 12))                            Text(category)                        }                        .font(.system(size: 13))                        .foregroundColor(.gray)                    }                                        if let address = event.address {                        HStack(spacing: 4) {                            Image(systemName: "mappin.circle.fill")                                .font(.system(size: 12))                            Text(address.components(separatedBy: ",").first ?? address)                                .lineLimit(1)                        }                        .font(.system(size: 13))                        .foregroundColor(.gray)                    }                }                                // Stats                HStack(spacing: 20) {                    HStack(spacing: 4) {                        Image(systemName: "person.2.fill")                            .font(.system(size: 14))                        Text("\(event.attendeesCount ?? 0) going")                            .font(.system(size: 14))                    }                    .foregroundColor(.black)                                        if (event.interestedCount ?? 0) > 0 {                        HStack(spacing: 4) {                            Image(systemName: "star.fill")                                .font(.system(size: 14))                            Text("\(event.interestedCount ?? 0) interested")                                .font(.system(size: 14))                        }                        .foregroundColor(.gray)                    }                }                                // Host                if let hostUsername = event.hostUsername {                    HStack(spacing: 8) {                        Circle()                            .fill(Color.black)                            .frame(width: 24, height: 24)                            .overlay(                                Text(hostUsername.prefix(1).uppercased())                                    .font(.system(size: 12, weight: .bold))                                    .foregroundColor(.white)                            )                                                Text("Hosted by @\(hostUsername)")                            .font(.system(size: 13))                            .foregroundColor(.gray)                    }                }            }            .padding()        }        .background(Color.white)        .cornerRadius(16)        .shadow(color: Color.black.opacity(0.1), radius: 8, y: 4)    }        func formatEventDate(_ date: Date) -> String {        let formatter = DateFormatter()                let calendar = Calendar.current        if calendar.isDateInToday(date) {            formatter.dateFormat = "'Today at' h:mm a"        } else if calendar.isDateInTomorrow(date) {            formatter.dateFormat = "'Tomorrow at' h:mm a"        } else {            formatter.dateFormat = "MMM d 'at' h:mm a"        }                return formatter.string(from: date)    }}class EventsViewModel: ObservableObject {    @Published var events: [Event] = []    @Published var myEvents: [Event] = []    @Published var attendingEvents: [Event] = []    @Published var isLoading = false        func loadAllEvents() {        isLoading = true        Task {            do {                let fetchedEvents = try await EventService.shared.getAllEvents()                await MainActor.run {                    self.events = fetchedEvents                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error loading events: \(error)")                }            }        }    }        func loadMyEvents() {        isLoading = true        Task {            do {                let fetchedEvents = try await EventService.shared.getMyHostedEvents()                await MainActor.run {                    self.myEvents = fetchedEvents                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error loading my events: \(error)")                }            }        }    }        func loadAttendingEvents() {        isLoading = true        Task {            do {                let fetchedEvents = try await EventService.shared.getMyAttendingEvents()                await MainActor.run {                    self.attendingEvents = fetchedEvents                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error loading attending events: \(error)")                }            }        }    }        func searchEvents(query: String) {        isLoading = true        Task {            do {                let results = try await EventService.shared.searchEvents(query: query)                await MainActor.run {                    self.events = results                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error searching events: \(error)")                }            }        }    }        func filterByCategory(_ category: EventCategory) {        isLoading = true        Task {            do {                let results = try await EventService.shared.getEventsByCategory(category: category)                await MainActor.run {                    self.events = results                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error filtering events: \(error)")                }            }        }    }}#Preview {    EventsView()}