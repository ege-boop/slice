//
//  CommentsView.swift
//  FinalProject
//
//  Created by Ahmet Aytac on 11/9/25.
//


import SwiftUIstruct CommentsView: View {    let post: Post    @Environment(\.dismiss) var dismiss    @StateObject private var viewModel: CommentsViewModel        init(post: Post) {        self.post = post        _viewModel = StateObject(wrappedValue: CommentsViewModel(post: post))    }        var body: some View {        NavigationView {            VStack(spacing: 0) {                // Comments List                ScrollView {                    LazyVStack(alignment: .leading, spacing: 16) {                        ForEach(viewModel.comments) { comment in                            CommentRow(comment: comment)                        }                    }                    .padding()                }                                Divider()                                // Add Comment Input                HStack(spacing: 12) {                    Circle()                        .fill(Color.black)                        .frame(width: 32, height: 32)                        .overlay(                            Text(User.current?.username?.prefix(1).uppercased() ?? "?")                                .font(.system(size: 14, weight: .bold))                                .foregroundColor(.white)                        )                                        TextField("Add a comment...", text: $viewModel.commentText)                        .textFieldStyle(PlainTextFieldStyle())                                        if !viewModel.commentText.isEmpty {                        Button(action: {                            viewModel.addComment()                        }) {                            if viewModel.isPosting {                                ProgressView()                            } else {                                Text("Post")                                    .font(.system(size: 14, weight: .semibold))                                    .foregroundColor(.blue)                            }                        }                        .disabled(viewModel.isPosting)                    }                }                .padding()                .background(Color(UIColor.systemBackground))            }            .navigationTitle("Comments")            .navigationBarTitleDisplayMode(.inline)            .toolbar {                ToolbarItem(placement: .navigationBarTrailing) {                    Button("Done") {                        dismiss()                    }                }            }        }        .onAppear {            viewModel.loadComments()        }    }}struct CommentRow: View {    let comment: Comment        var body: some View {        HStack(alignment: .top, spacing: 12) {            Circle()                .fill(Color.black)                .frame(width: 36, height: 36)                .overlay(                    Text(comment.username?.prefix(1).uppercased() ?? "?")                        .font(.system(size: 14, weight: .bold))                        .foregroundColor(.white)                )                        VStack(alignment: .leading, spacing: 4) {                HStack(spacing: 6) {                    Text(comment.username ?? "Unknown")                        .font(.system(size: 14, weight: .semibold))                                        if let time = comment.createdAt {                        Text(timeAgo(from: time))                            .font(.system(size: 12))                            .foregroundColor(.gray)                    }                }                                Text(comment.text ?? "")                    .font(.system(size: 14))            }                        Spacer()        }    }        func timeAgo(from date: Date) -> String {        let seconds = Date().timeIntervalSince(date)        if seconds < 60 { return "now" }        if seconds < 3600 { return "\(Int(seconds / 60))m" }        if seconds < 86400 { return "\(Int(seconds / 3600))h" }        let formatter = DateFormatter()        formatter.dateFormat = "MMM d"        return formatter.string(from: date)    }}class CommentsViewModel: ObservableObject {    let post: Post    @Published var comments: [Comment] = []    @Published var commentText = ""    @Published var isPosting = false        init(post: Post) {        self.post = post    }        func loadComments() {        guard let postId = post.objectId else { return }                Task {            do {                let fetchedComments = try await SocialService.shared.getComments(postId: postId)                await MainActor.run {                    self.comments = fetchedComments                }            } catch {                print("Error loading comments: \(error)")            }        }    }        func addComment() {        guard !commentText.isEmpty,              let postId = post.objectId else { return }                isPosting = true                Task {            do {                let newComment = try await SocialService.shared.addComment(postId: postId, text: commentText)                await MainActor.run {                    self.comments.append(newComment)                    self.commentText = ""                    self.isPosting = false                }            } catch {                await MainActor.run {                    self.isPosting = false                    print("Error adding comment: \(error)")                }            }        }    }}#Preview {    CommentsView(post: Post())}