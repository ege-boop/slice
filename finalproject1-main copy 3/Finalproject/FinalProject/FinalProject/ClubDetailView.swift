import SwiftUIimport MapKitstruct ClubDetailView: View {    let club: Club    @StateObject private var viewModel: ClubDetailViewModel    @Environment(\.dismiss) var dismiss        init(club: Club) {        self.club = club        _viewModel = StateObject(wrappedValue: ClubDetailViewModel(club: club))    }        var body: some View {        ScrollView {            VStack(spacing: 0) {                // Header with Club Banner & Profile Image                ZStack(alignment: .bottom) {                    // Banner Image                    if let bannerURL = club.bannerImageURL,                       !bannerURL.isEmpty,                       let url = URL(string: bannerURL) {                        AsyncImage(url: url) { phase in                            switch phase {                            case .success(let image):                                image                                    .resizable()                                    .scaledToFill()                                    .frame(height: 200)                                    .clipped()                            case .empty, .failure:                                LinearGradient(                                    colors: [Color.black, Color.gray.opacity(0.8)],                                    startPoint: .topLeading,                                    endPoint: .bottomTrailing                                )                                .frame(height: 200)                            @unknown default:                                LinearGradient(                                    colors: [Color.black, Color.gray.opacity(0.8)],                                    startPoint: .topLeading,                                    endPoint: .bottomTrailing                                )                                .frame(height: 200)                            }                        }                    } else {                        LinearGradient(                            colors: [Color.black, Color.gray.opacity(0.8)],                            startPoint: .topLeading,                            endPoint: .bottomTrailing                        )                        .frame(height: 200)                    }                                        // Club Profile Picture                    VStack {                        Spacer()                        if let profileURL = club.profileImageURL,                           !profileURL.isEmpty,                           let url = URL(string: profileURL) {                            AsyncImage(url: url) { phase in                                switch phase {                                case .success(let image):                                    image                                        .resizable()                                        .scaledToFill()                                        .frame(width: 100, height: 100)                                        .clipShape(Circle())                                        .overlay(                                            Circle()                                                .stroke(Color.white, lineWidth: 4)                                        )                                case .empty, .failure:                                    Circle()                                        .fill(Color.white)                                        .frame(width: 100, height: 100)                                        .overlay(                                            Text(club.name?.prefix(1).uppercased() ?? "C")                                                .font(.system(size: 40, weight: .bold))                                                .foregroundColor(.black)                                        )                                @unknown default:                                    Circle()                                        .fill(Color.white)                                        .frame(width: 100, height: 100)                                        .overlay(                                            Text(club.name?.prefix(1).uppercased() ?? "C")                                                .font(.system(size: 40, weight: .bold))                                                .foregroundColor(.black)                                        )                                }                            }                            .offset(y: 50)                        } else {                            Circle()                                .fill(Color.white)                                .frame(width: 100, height: 100)                                .overlay(                                    Text(club.name?.prefix(1).uppercased() ?? "C")                                        .font(.system(size: 40, weight: .bold))                                        .foregroundColor(.black)                                )                                .offset(y: 50)                        }                    }                }                                // Club Info                VStack(spacing: 20) {                    VStack(spacing: 8) {                        Text(club.name ?? "Club")                            .font(.system(size: 28, weight: .bold))                            .padding(.top, 60)                                                if let category = club.category {                            Text(category)                                .font(.system(size: 14))                                .foregroundColor(.white)                                .padding(.horizontal, 16)                                .padding(.vertical, 6)                                .background(Color.black)                                .cornerRadius(20)                        }                    }                                        // Description                    if let description = club.description, !description.isEmpty {                        Text(description)                            .font(.system(size: 15))                            .foregroundColor(.gray)                            .multilineTextAlignment(.center)                            .padding(.horizontal, 40)                    }                                        // Stats                    HStack(spacing: 40) {                        VStack(spacing: 4) {                            Text("\(club.memberCount ?? 0)")                                .font(.system(size: 22, weight: .bold))                            Text("Members")                                .font(.system(size: 12))                                .foregroundColor(.gray)                        }                                                VStack(spacing: 4) {                            Text(club.privacy ?? "Public")                                .font(.system(size: 22, weight: .bold))                            Text("Privacy")                                .font(.system(size: 12))                                .foregroundColor(.gray)                        }                    }                    .padding()                    .background(Color.gray.opacity(0.1))                    .cornerRadius(12)                    .padding(.horizontal)                                        // Join/Leave Button                    if viewModel.isMember {                        Button(action: {                            viewModel.leaveClub()                        }) {                            if viewModel.isLoading {                                ProgressView()                                    .progressViewStyle(CircularProgressViewStyle(tint: .black))                            } else {                                HStack {                                    Image(systemName: "checkmark.circle.fill")                                    Text("Member")                                        .font(.system(size: 16, weight: .semibold))                                }                                .foregroundColor(.black)                            }                        }                        .frame(maxWidth: .infinity)                        .padding(.vertical, 14)                        .background(Color.gray.opacity(0.2))                        .cornerRadius(12)                        .padding(.horizontal)                        .disabled(viewModel.isLoading)                    } else {                        Button(action: {                            viewModel.joinClub()                        }) {                            if viewModel.isLoading {                                ProgressView()                                    .progressViewStyle(CircularProgressViewStyle(tint: .white))                            } else {                                HStack {                                    Image(systemName: "person.badge.plus")                                    Text("Join Club")                                        .font(.system(size: 16, weight: .semibold))                                }                                .foregroundColor(.white)                            }                        }                        .frame(maxWidth: .infinity)                        .padding(.vertical, 14)                        .background(Color.black)                        .cornerRadius(12)                        .padding(.horizontal)                        .disabled(viewModel.isLoading)                    }                                        Divider()                                        // Location                    if let address = club.address {                        VStack(alignment: .leading, spacing: 12) {                            HStack {                                Image(systemName: "mappin.circle.fill")                                    .foregroundColor(.black)                                Text("Location")                                    .font(.system(size: 18, weight: .semibold))                            }                                                        Text(address)                                .font(.system(size: 14))                                .foregroundColor(.gray)                                                        // Map                            Map(coordinateRegion: .constant(MKCoordinateRegion(                                center: club.coordinate,                                span: MKCoordinateSpan(latitudeDelta: 0.01, longitudeDelta: 0.01)                            )), annotationItems: [club]) { club in                                MapPin(coordinate: club.coordinate, tint: .red)                            }                            .frame(height: 150)                            .cornerRadius(12)                            .allowsHitTesting(false)                        }                        .padding()                        .background(Color.gray.opacity(0.05))                        .cornerRadius(12)                        .padding(.horizontal)                    }                                        Divider()                                        // Members Preview                    VStack(alignment: .leading, spacing: 16) {                        HStack {                            Text("Members")                                .font(.system(size: 20, weight: .bold))                            Spacer()                            if viewModel.userRole == "admin" || viewModel.userRole == "leader" {                                Button("Manage") {                                    viewModel.showSettings = true                                }                                .font(.system(size: 14, weight: .semibold))                                .foregroundColor(.blue)                            }                        }                        .padding(.horizontal)                                                if viewModel.isLoadingMembers {                            ProgressView()                                .padding()                        } else if viewModel.members.isEmpty {                            Text("No members yet")                                .font(.system(size: 14))                                .foregroundColor(.gray)                                .frame(maxWidth: .infinity)                                .padding()                        } else {                            ScrollView(.horizontal, showsIndicators: false) {                                HStack(spacing: 16) {                                    ForEach(viewModel.members.prefix(10), id: \.user.objectId) { member in                                        NavigationLink(destination: UserProfileView(user: member.user)) {                                            VStack(spacing: 8) {                                                // Show profile picture                                                if let imageURL = member.user.profileImageURL,                                                   !imageURL.isEmpty,                                                   let url = URL(string: imageURL) {                                                    AsyncImage(url: url) { phase in                                                        switch phase {                                                        case .success(let image):                                                            image                                                                .resizable()                                                                .scaledToFill()                                                                .frame(width: 60, height: 60)                                                                .clipShape(Circle())                                                        case .empty, .failure:                                                            Circle()                                                                .fill(Color.black)                                                                .frame(width: 60, height: 60)                                                                .overlay(                                                                    Text(member.user.username?.prefix(1).uppercased() ?? "?")                                                                        .font(.system(size: 24, weight: .bold))                                                                        .foregroundColor(.white)                                                                )                                                        @unknown default:                                                            Circle()                                                                .fill(Color.black)                                                                .frame(width: 60, height: 60)                                                                .overlay(                                                                    Text(member.user.username?.prefix(1).uppercased() ?? "?")                                                                        .font(.system(size: 24, weight: .bold))                                                                        .foregroundColor(.white)                                                                )                                                        }                                                    }                                                } else {                                                    Circle()                                                        .fill(Color.black)                                                        .frame(width: 60, height: 60)                                                        .overlay(                                                            Text(member.user.username?.prefix(1).uppercased() ?? "?")                                                                .font(.system(size: 24, weight: .bold))                                                                .foregroundColor(.white)                                                        )                                                }                                                                                                Text(member.user.username ?? "User")                                                    .font(.system(size: 12))                                                    .foregroundColor(.primary)                                                    .lineLimit(1)                                                                                                // Role badge                                                if member.role != "member" {                                                    Text(member.role.capitalized)                                                        .font(.system(size: 10, weight: .semibold))                                                        .foregroundColor(.white)                                                        .padding(.horizontal, 6)                                                        .padding(.vertical, 2)                                                        .background(roleColor(for: member.role))                                                        .cornerRadius(8)                                                }                                            }                                            .frame(width: 80)                                        }                                    }                                }                                .padding(.horizontal)                            }                                                        if viewModel.members.count > 10 {                                Button("View All \(viewModel.members.count) Members") {                                    viewModel.showSettings = true                                }                                .font(.system(size: 14))                                .foregroundColor(.blue)                                .padding(.horizontal)                            }                        }                    }                }                .padding(.bottom, 40)            }        }        .navigationBarTitleDisplayMode(.inline)        .toolbar {            ToolbarItem(placement: .navigationBarTrailing) {                if viewModel.userRole == "admin" || viewModel.userRole == "leader" {                    Button(action: {                        viewModel.showSettings = true                    }) {                        Image(systemName: "gearshape.fill")                            .foregroundColor(.black)                    }                }            }        }        .sheet(isPresented: $viewModel.showSettings) {            ClubSettingsView(club: club)        }        .onAppear {            viewModel.loadData()        }        .refreshable {            viewModel.loadData()        }    }        func roleColor(for role: String) -> Color {        switch role {        case "admin":            return .red        case "leader":            return .orange        case "moderator":            return .blue        default:            return .gray        }    }}class ClubDetailViewModel: ObservableObject {    let club: Club    @Published var isMember = false    @Published var isLoading = false    @Published var isLoadingMembers = false    @Published var members: [(user: User, role: String)] = []    @Published var userRole: String?    @Published var showSettings = false        init(club: Club) {        self.club = club    }        func loadData() {        checkMembership()        loadMembers()        getUserRole()    }        func checkMembership() {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                Task {            do {                let member = try await ParseService.shared.checkMembership(userId: userId, clubId: clubId)                await MainActor.run {                    self.isMember = member                }            } catch {                print("Error checking membership: \(error)")            }        }    }        func getUserRole() {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                Task {            do {                let role = try await ParseService.shared.getUserRoleInClub(userId: userId, clubId: clubId)                await MainActor.run {                    self.userRole = role                }            } catch {                print("Error getting user role: \(error)")            }        }    }        func joinClub() {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                isLoading = true                Task {            do {                try await ParseService.shared.joinClub(userId: userId, clubId: clubId)                await MainActor.run {                    self.isMember = true                    self.isLoading = false                    self.loadMembers()                    self.getUserRole()                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error joining club: \(error)")                }            }        }    }        func leaveClub() {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                isLoading = true                Task {            do {                try await ParseService.shared.leaveClub(userId: userId, clubId: clubId)                await MainActor.run {                    self.isMember = false                    self.isLoading = false                    self.loadMembers()                    self.userRole = nil                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error leaving club: \(error)")                }            }        }    }        func loadMembers() {        guard let clubId = club.objectId else { return }                isLoadingMembers = true                Task {            do {                let members = try await ParseService.shared.getClubMembersWithRoles(clubId: clubId)                await MainActor.run {                    self.members = members                    self.isLoadingMembers = false                }            } catch {                await MainActor.run {                    self.isLoadingMembers = false                    print("Error loading members: \(error)")                }            }        }    }}// Make Club identifiable for Mapextension Club: Identifiable {    var id: String? { objectId }}#Preview {    NavigationView {        ClubDetailView(club: Club())    }}