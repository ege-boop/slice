//
//  SocialService.swift
//  FinalProject
//
//  Created by Ahmet Aytac on 11/16/25.
//


////  SocialService_Improved.swift//  FinalProject////  Enhanced with better search and member visibility//import Foundationimport ParseSwiftimport UIKitclass SocialService {    static let shared = SocialService()        private init() {}            /// Create a new post with image and caption    func createPost(image: UIImage, caption: String, clubId: String? = nil) async throws -> Post {        guard let userId = User.current?.objectId,              let username = User.current?.username else {            throw NSError(domain: "SocialService", code: 401, userInfo: [NSLocalizedDescriptionKey: "User not logged in"])        }                // Convert image to data        guard let imageData = image.jpegData(compressionQuality: 0.7) else {            throw NSError(domain: "SocialService", code: 400, userInfo: [NSLocalizedDescriptionKey: "Failed to process image"])        }                // Create Parse file        let parseFile = ParseFile(name: "post_\(UUID().uuidString).jpg", data: imageData)        let savedFile = try await parseFile.save()                // Create post        var post = Post()        post.userId = userId        post.username = username        post.caption = caption        post.imageFile = savedFile        post.imageURL = savedFile.url?.absoluteString        post.likesCount = 0        post.commentsCount = 0        post.type = clubId != nil ? "club" : "personal"        post.clubId = clubId                let savedPost = try await post.save()        print("✅ Post created: \(savedPost.objectId ?? "unknown")")                // Update user's post count        if var user = User.current {            user.postsCount = (user.postsCount ?? 0) + 1            _ = try? await user.save()        }                return savedPost    }        /// Get all posts (feed) with pagination    func getFeed(limit: Int = 50, skip: Int = 0) async throws -> [Post] {        let query = Post.query()            .order([.descending("createdAt")])            .limit(limit)                let posts = try await query.find()        print("✅ Fetched \(posts.count) posts")        return posts    }        /// Get posts by specific user    func getUserPosts(userId: String) async throws -> [Post] {        let query = Post.query()            .order([.descending("createdAt")])                let allPosts = try await query.find()        let userPosts = allPosts.filter { $0.userId == userId }        return userPosts    }        /// Get posts for a specific club    func getClubPosts(clubId: String) async throws -> [Post] {        let query = Post.query()            .order([.descending("createdAt")])                let allPosts = try await query.find()        let clubPosts = allPosts.filter { $0.clubId == clubId }        return clubPosts    }        /// Delete a post    func deletePost(postId: String) async throws {        let allPosts = try await Post.query().find()        if let post = allPosts.first(where: { $0.objectId == postId }) {            try await post.delete()                        // Update user's post count            if var user = User.current {                user.postsCount = max(0, (user.postsCount ?? 1) - 1)                _ = try? await user.save()            }                        print("✅ Post deleted")        }    }            /// Like a post    func likePost(postId: String) async throws {        guard let userId = User.current?.objectId else {            throw NSError(domain: "SocialService", code: 401, userInfo: [NSLocalizedDescriptionKey: "User not logged in"])        }                // Check if already liked        let isLiked = try await checkIfLiked(postId: postId, userId: userId)        if isLiked {            print("⚠️ Already liked")            return        }                // Create like        var like = Like()        like.postId = postId        like.userId = userId                _ = try await like.save()                // Update post likes count        let allPosts = try await Post.query().find()        if var post = allPosts.first(where: { $0.objectId == postId }) {            post.likesCount = (post.likesCount ?? 0) + 1            _ = try await post.save()        }                print("✅ Post liked")    }        /// Unlike a post    func unlikePost(postId: String) async throws {        guard let userId = User.current?.objectId else { return }                let allLikes = try await Like.query().find()        if let like = allLikes.first(where: { $0.postId == postId && $0.userId == userId }) {            try await like.delete()                        // Update post likes count            let allPosts = try await Post.query().find()            if var post = allPosts.first(where: { $0.objectId == postId }) {                post.likesCount = max(0, (post.likesCount ?? 1) - 1)                _ = try await post.save()            }                        print("✅ Post unliked")        }    }        /// Check if user liked a post    func checkIfLiked(postId: String, userId: String) async throws -> Bool {        let allLikes = try await Like.query().find()        return allLikes.contains { $0.postId == postId && $0.userId == userId }    }            /// Add comment to post    func addComment(postId: String, text: String) async throws -> Comment {        guard let userId = User.current?.objectId,              let username = User.current?.username else {            throw NSError(domain: "SocialService", code: 401, userInfo: [NSLocalizedDescriptionKey: "User not logged in"])        }                var comment = Comment()        comment.postId = postId        comment.userId = userId        comment.username = username        comment.text = text                let savedComment = try await comment.save()                // Update post comments count        let allPosts = try await Post.query().find()        if var post = allPosts.first(where: { $0.objectId == postId }) {            post.commentsCount = (post.commentsCount ?? 0) + 1            _ = try await post.save()        }                print("✅ Comment added")        return savedComment    }        /// Get comments for a post    func getComments(postId: String) async throws -> [Comment] {        let allComments = try await Comment.query().find()        let postComments = allComments.filter { $0.postId == postId }        return postComments.sorted { ($0.createdAt ?? Date()) < ($1.createdAt ?? Date()) }    }        /// Delete comment    func deleteComment(commentId: String) async throws {        let allComments = try await Comment.query().find()        if let comment = allComments.first(where: { $0.objectId == commentId }) {            let postId = comment.postId            try await comment.delete()                        // Update post comments count            if let postId = postId {                let allPosts = try await Post.query().find()                if var post = allPosts.first(where: { $0.objectId == postId }) {                    post.commentsCount = max(0, (post.commentsCount ?? 1) - 1)                    _ = try await post.save()                }            }                        print("✅ Comment deleted")        }    }            /// Follow a user    func followUser(userId: String) async throws {        guard let currentUserId = User.current?.objectId else {            throw NSError(domain: "SocialService", code: 401, userInfo: [NSLocalizedDescriptionKey: "User not logged in"])        }                // Check if already following        let isFollowing = try await checkIfFollowing(userId: userId)        if isFollowing {            print("⚠️ Already following")            return        }                // Create friendship        var friendship = Friendship()        friendship.followerId = currentUserId        friendship.followingId = userId        friendship.status = "accepted"                _ = try await friendship.save()                // Update follower/following counts        if var currentUser = User.current {            currentUser.followingCount = (currentUser.followingCount ?? 0) + 1            _ = try? await currentUser.save()        }                let allUsers = try await User.query().find()        if var targetUser = allUsers.first(where: { $0.objectId == userId }) {            targetUser.followersCount = (targetUser.followersCount ?? 0) + 1            _ = try? await targetUser.save()        }                print("✅ User followed")    }        /// Unfollow a user    func unfollowUser(userId: String) async throws {        guard let currentUserId = User.current?.objectId else { return }                let allFriendships = try await Friendship.query().find()        if let friendship = allFriendships.first(where: {             $0.followerId == currentUserId && $0.followingId == userId         }) {            try await friendship.delete()                        // Update counts            if var currentUser = User.current {                currentUser.followingCount = max(0, (currentUser.followingCount ?? 1) - 1)                _ = try? await currentUser.save()            }                        let allUsers = try await User.query().find()            if var targetUser = allUsers.first(where: { $0.objectId == userId }) {                targetUser.followersCount = max(0, (targetUser.followersCount ?? 1) - 1)                _ = try? await targetUser.save()            }                        print("✅ User unfollowed")        }    }        /// Check if following a user    func checkIfFollowing(userId: String) async throws -> Bool {        guard let currentUserId = User.current?.objectId else { return false }                let allFriendships = try await Friendship.query().find()        return allFriendships.contains {             $0.followerId == currentUserId && $0.followingId == userId         }    }        /// Get followers list    func getFollowers(userId: String) async throws -> [User] {        let allFriendships = try await Friendship.query().find()        let followerIds = allFriendships            .filter { $0.followingId == userId }            .compactMap { $0.followerId }                let allUsers = try await User.query().find()        return allUsers.filter { user in            guard let id = user.objectId else { return false }            return followerIds.contains(id)        }    }        /// Get following list    func getFollowing(userId: String) async throws -> [User] {        let allFriendships = try await Friendship.query().find()        let followingIds = allFriendships            .filter { $0.followerId == userId }            .compactMap { $0.followingId }                let allUsers = try await User.query().find()        return allUsers.filter { user in            guard let id = user.objectId else { return false }            return followingIds.contains(id)        }    }            /// IMPROVED: Search users by username with @ support    func searchUsers(query: String) async throws -> [User] {        let allUsers = try await User.query().find()                // Remove @ symbol if user typed it        let cleanQuery = query.hasPrefix("@") ? String(query.dropFirst()) : query                guard !cleanQuery.isEmpty else { return [] }                return allUsers.filter { user in            // Search by username            if let username = user.username?.lowercased(),               username.contains(cleanQuery.lowercased()) {                return true            }                        // Search by display name if exists            if let displayName = user.displayName?.lowercased(),               displayName.contains(cleanQuery.lowercased()) {                return true            }                        // Search by searchable name field            if let searchableName = user.searchableName?.lowercased(),               searchableName.contains(cleanQuery.lowercased()) {                return true            }                        return false        }    }        /// NEW: Get suggested users to follow    func getSuggestedUsers(limit: Int = 10) async throws -> [User] {        guard let currentUserId = User.current?.objectId else { return [] }                let allUsers = try await User.query().find()        let allFriendships = try await Friendship.query().find()                // Get users current user is already following        let followingIds = allFriendships            .filter { $0.followerId == currentUserId }            .compactMap { $0.followingId }                // Filter out current user and already followed users        let suggestions = allUsers.filter { user in            guard let userId = user.objectId else { return false }            return userId != currentUserId && !followingIds.contains(userId)        }                // Sort by followers count (popular users first)        let sorted = suggestions.sorted { ($0.followersCount ?? 0) > ($1.followersCount ?? 0) }                return Array(sorted.prefix(limit))    }}