import SwiftUIimport ParseSwiftimport CoreLocationimport MapKitstruct ExploreView: View {    @StateObject private var viewModel = ExploreViewModel()    @State private var searchText = ""    @State private var selectedCategory: ClubCategory?    @State private var showCreateClub = false    @State private var showMap = false // Toggle between list and map    @State private var region = MKCoordinateRegion(        center: CLLocationCoordinate2D(latitude: 37.7749, longitude: -122.4194),        span: MKCoordinateSpan(latitudeDelta: 0.5, longitudeDelta: 0.5)    )        var body: some View {        NavigationView {            VStack(spacing: 0) {                // Search Bar                HStack(spacing: 12) {                    HStack(spacing: 8) {                        Image(systemName: "magnifyingglass")                            .foregroundColor(.gray)                                                TextField("Search clubs...", text: $searchText)                            .onChange(of: searchText) {                                viewModel.searchClubs(query: searchText)                            }                    }                    .padding(12)                    .background(Color.black.opacity(0.05))                    .cornerRadius(12)                                        if !searchText.isEmpty {                        Button(action: {                            searchText = ""                            viewModel.searchClubs(query: "")                        }) {                            Image(systemName: "xmark.circle.fill")                                .foregroundColor(.gray)                        }                    }                }                .padding()                                // Category Filters                ScrollView(.horizontal, showsIndicators: false) {                    HStack(spacing: 12) {                        CategoryButton(                            title: "All",                            isSelected: selectedCategory == nil                        ) {                            selectedCategory = nil                            viewModel.loadAllClubs()                        }                                                ForEach(ClubCategory.allCases, id: \.self) { category in                            CategoryButton(                                title: category.rawValue,                                isSelected: selectedCategory == category                            ) {                                selectedCategory = category                                viewModel.filterByCategory(category)                            }                        }                    }                    .padding(.horizontal)                }                .padding(.bottom)                                Divider()                                // Toggle between List and Map                HStack {                    Button(action: { showMap = false }) {                        HStack {                            Image(systemName: "list.bullet")                            Text("List")                        }                        .font(.system(size: 14, weight: .medium))                        .foregroundColor(showMap ? .gray : .white)                        .padding(.horizontal, 20)                        .padding(.vertical, 8)                        .background(showMap ? Color.clear : Color.black)                        .cornerRadius(8)                    }                                        Button(action: { showMap = true }) {                        HStack {                            Image(systemName: "map")                            Text("Map")                        }                        .font(.system(size: 14, weight: .medium))                        .foregroundColor(showMap ? .white : .gray)                        .padding(.horizontal, 20)                        .padding(.vertical, 8)                        .background(showMap ? Color.black : Color.clear)                        .cornerRadius(8)                    }                                        Spacer()                }                .padding()                                Divider()                                // Content - List or Map                if viewModel.isLoading {                    ProgressView()                        .padding(.top, 50)                    Spacer()                } else if viewModel.clubs.isEmpty {                    VStack(spacing: 20) {                        Image(systemName: "magnifyingglass")                            .font(.system(size: 60))                            .foregroundColor(.gray)                                                Text("No clubs found")                            .font(.system(size: 20, weight: .semibold))                                                Button("Create First Club") {                            showCreateClub = true                        }                        .padding()                        .background(Color.black)                        .foregroundColor(.white)                        .cornerRadius(10)                    }                    .padding(.top, 50)                    Spacer()                } else {                    if showMap {                        // Map View                        Map(coordinateRegion: $region, annotationItems: viewModel.clubs) { club in                            MapAnnotation(coordinate: club.coordinate) {                                NavigationLink(destination: ClubDetailView(club: club)) {                                    VStack(spacing: 4) {                                        ZStack {                                            Circle()                                                .fill(categoryColor(for: club.category))                                                .frame(width: 40, height: 40)                                                .shadow(radius: 4)                                                                                        Text(club.name?.prefix(1).uppercased() ?? "?")                                                .font(.system(size: 16, weight: .bold))                                                .foregroundColor(.white)                                        }                                                                                Text(club.name ?? "")                                            .font(.system(size: 10, weight: .medium))                                            .foregroundColor(.black)                                            .padding(.horizontal, 6)                                            .padding(.vertical, 2)                                            .background(Color.white)                                            .cornerRadius(4)                                            .shadow(radius: 2)                                    }                                }                            }                        }                        .ignoresSafeArea(edges: .bottom)                        .onAppear {                            centerMapOnClubs()                        }                    } else {                        // List View                        ScrollView {                            LazyVStack(spacing: 0) {                                ForEach(viewModel.clubs, id: \.objectId) { club in                                    NavigationLink(destination: ClubDetailView(club: club)) {                                        ClubRow(club: club)                                    }                                    .buttonStyle(PlainButtonStyle())                                    Divider().padding(.leading, 80)                                }                            }                        }                    }                }            }            .navigationTitle("Explore")            .toolbar {                ToolbarItem(placement: .navigationBarTrailing) {                    Button(action: { showCreateClub = true }) {                        Image(systemName: "plus")                            .foregroundColor(.black)                    }                }            }            .sheet(isPresented: $showCreateClub) {                CreateClubView()            }        }        .onAppear {            viewModel.loadAllClubs()        }    }        func centerMapOnClubs() {        guard !viewModel.clubs.isEmpty else { return }                let coordinates = viewModel.clubs.map { $0.coordinate }        let minLat = coordinates.map { $0.latitude }.min() ?? 0        let maxLat = coordinates.map { $0.latitude }.max() ?? 0        let minLon = coordinates.map { $0.longitude }.min() ?? 0        let maxLon = coordinates.map { $0.longitude }.max() ?? 0                let center = CLLocationCoordinate2D(            latitude: (minLat + maxLat) / 2,            longitude: (minLon + maxLon) / 2        )                let span = MKCoordinateSpan(            latitudeDelta: max(0.05, (maxLat - minLat) * 1.5),            longitudeDelta: max(0.05, (maxLon - minLon) * 1.5)        )                region = MKCoordinateRegion(center: center, span: span)    }        func categoryColor(for category: String?) -> Color {        switch category {        case "Sport": return .blue        case "Tech": return .purple        case "Music": return .pink        case "Arts": return .orange        case "Gaming": return .green        case "Business": return .indigo        case "Education": return .cyan        case "Social": return .red        default: return .black        }    }}struct CategoryButton: View {    let title: String    let isSelected: Bool    let action: () -> Void        var body: some View {        Button(action: action) {            Text(title)                .font(.system(size: 14, weight: .medium))                .foregroundColor(isSelected ? .white : .black)                .padding(.horizontal, 16)                .padding(.vertical, 8)                .background(isSelected ? Color.black : Color.black.opacity(0.05))                .cornerRadius(20)        }    }}struct ClubRow: View {    let club: Club        var body: some View {        HStack(spacing: 16) {            // Club Icon - WITH IMAGE            if let profileURL = club.profileImageURL,               !profileURL.isEmpty,               let url = URL(string: profileURL) {                AsyncImage(url: url) { phase in                    switch phase {                    case .success(let image):                        image                            .resizable()                            .scaledToFill()                            .frame(width: 64, height: 64)                            .clipShape(RoundedRectangle(cornerRadius: 12))                    case .empty, .failure:                        RoundedRectangle(cornerRadius: 12)                            .fill(Color.black)                            .frame(width: 64, height: 64)                            .overlay(                                Text(club.name?.prefix(1).uppercased() ?? "?")                                    .font(.system(size: 24, weight: .bold))                                    .foregroundColor(.white)                            )                    @unknown default:                        RoundedRectangle(cornerRadius: 12)                            .fill(Color.black)                            .frame(width: 64, height: 64)                            .overlay(                                Text(club.name?.prefix(1).uppercased() ?? "?")                                    .font(.system(size: 24, weight: .bold))                                    .foregroundColor(.white)                            )                    }                }            } else {                RoundedRectangle(cornerRadius: 12)                    .fill(Color.black)                    .frame(width: 64, height: 64)                    .overlay(                        Text(club.name?.prefix(1).uppercased() ?? "?")                            .font(.system(size: 24, weight: .bold))                            .foregroundColor(.white)                    )            }                        VStack(alignment: .leading, spacing: 6) {                Text(club.name ?? "Unknown Club")                    .font(.system(size: 16, weight: .semibold))                    .foregroundColor(.black)                                Text(club.description ?? "")                    .font(.system(size: 14))                    .foregroundColor(.gray)                    .lineLimit(2)                                HStack(spacing: 8) {                    Text(club.category ?? "Other")                        .font(.system(size: 12, weight: .medium))                        .padding(.horizontal, 8)                        .padding(.vertical, 4)                        .background(Color.black.opacity(0.05))                        .cornerRadius(6)                                        Text("\(club.memberCount ?? 0) members")                        .font(.system(size: 12))                        .foregroundColor(.gray)                }            }                        Spacer()        }        .padding()    }}struct CreateClubView: View {    @Environment(\.dismiss) var dismiss    @State private var clubName = ""    @State private var clubDescription = ""    @State private var selectedCategory: ClubCategory = .social    @State private var isPrivate = false    @State private var isCreating = false    @State private var errorMessage = ""        // Location    @State private var selectedLocation: MKMapItem?    @State private var showingLocationSearch = false        var body: some View {        NavigationView {            Form {                Section("Club Info") {                    TextField("Club Name", text: $clubName)                    TextField("Description", text: $clubDescription, axis: .vertical)                        .lineLimit(3...5)                }                                Section("Category") {                    Picker("Category", selection: $selectedCategory) {                        ForEach(ClubCategory.allCases, id: \.self) { category in                            Text(category.rawValue).tag(category)                        }                    }                }                                Section("Location") {                    Button(action: {                        showingLocationSearch = true                    }) {                        HStack {                            Image(systemName: "mappin.circle.fill")                                .foregroundColor(.red)                                                        if let location = selectedLocation {                                VStack(alignment: .leading, spacing: 4) {                                    Text(location.name ?? "Location")                                        .foregroundColor(.black)                                    if let address = location.placemark.title {                                        Text(address)                                            .font(.system(size: 12))                                            .foregroundColor(.gray)                                    }                                }                            } else {                                Text("Search for location")                                    .foregroundColor(.gray)                            }                                                        Spacer()                                                        Image(systemName: "chevron.right")                                .font(.system(size: 12))                                .foregroundColor(.gray)                        }                    }                }                                Section("Privacy") {                    Toggle("Private Club", isOn: $isPrivate)                }                                if !errorMessage.isEmpty {                    Section {                        Text(errorMessage)                            .foregroundColor(.red)                            .font(.system(size: 14))                    }                }                                Section {                    Button(action: createClub) {                        if isCreating {                            HStack {                                Spacer()                                ProgressView()                                Spacer()                            }                        } else {                            Text("Create Club")                                .frame(maxWidth: .infinity)                                .foregroundColor(.white)                        }                    }                    .listRowBackground(Color.black)                    .disabled(clubName.isEmpty || selectedLocation == nil || isCreating)                }            }            .navigationTitle("Create Club")            .navigationBarTitleDisplayMode(.inline)            .toolbar {                ToolbarItem(placement: .navigationBarLeading) {                    Button("Cancel") {                        dismiss()                    }                }            }            .sheet(isPresented: $showingLocationSearch) {                LocationSearchView(selectedLocation: $selectedLocation)            }        }    }        func createClub() {        guard let location = selectedLocation else {            errorMessage = "Please select a location"            return        }                errorMessage = ""        isCreating = true                Task {            do {                let coordinate = location.placemark.coordinate                let address = [                    location.placemark.name,                    location.placemark.locality,                    location.placemark.administrativeArea,                    location.placemark.postalCode                ].compactMap { $0 }.joined(separator: ", ")                                _ = try await ParseService.shared.createClub(                    name: clubName,                    description: clubDescription,                    category: selectedCategory,                    location: coordinate,                    address: address,                    isPrivate: isPrivate                )                                await MainActor.run {                    isCreating = false                    dismiss()                }            } catch {                await MainActor.run {                    isCreating = false                    errorMessage = "Error: \(error.localizedDescription)"                    print("Error creating club: \(error)")                }            }        }    }}struct LocationSearchView: View {    @Environment(\.dismiss) var dismiss    @Binding var selectedLocation: MKMapItem?        @State private var searchText = ""    @State private var searchResults: [MKMapItem] = []    @State private var isSearching = false        var body: some View {        NavigationView {            VStack(spacing: 0) {                HStack(spacing: 12) {                    Image(systemName: "magnifyingglass")                        .foregroundColor(.gray)                                        TextField("Search for a place", text: $searchText)                        .textFieldStyle(PlainTextFieldStyle())                        .onChange(of: searchText) {                            searchLocation()                        }                                        if !searchText.isEmpty {                        Button(action: {                            searchText = ""                            searchResults = []                        }) {                            Image(systemName: "xmark.circle.fill")                                .foregroundColor(.gray)                        }                    }                }                .padding()                .background(Color.gray.opacity(0.1))                                Divider()                                if isSearching {                    ProgressView()                        .padding(.top, 40)                    Spacer()                } else if searchResults.isEmpty && !searchText.isEmpty {                    VStack(spacing: 12) {                        Image(systemName: "mappin.slash")                            .font(.system(size: 50))                            .foregroundColor(.gray)                        Text("No locations found")                            .foregroundColor(.gray)                    }                    .padding(.top, 40)                    Spacer()                } else {                    List(searchResults, id: \.self) { item in                        Button(action: {                            selectedLocation = item                            dismiss()                        }) {                            VStack(alignment: .leading, spacing: 4) {                                Text(item.name ?? "Unknown")                                    .font(.system(size: 16, weight: .medium))                                    .foregroundColor(.black)                                                                if let address = item.placemark.title {                                    Text(address)                                        .font(.system(size: 14))                                        .foregroundColor(.gray)                                }                            }                            .padding(.vertical, 4)                        }                    }                    .listStyle(PlainListStyle())                }            }            .navigationTitle("Search Location")            .navigationBarTitleDisplayMode(.inline)            .toolbar {                ToolbarItem(placement: .navigationBarLeading) {                    Button("Cancel") {                        dismiss()                    }                }            }        }    }        func searchLocation() {        guard !searchText.isEmpty else {            searchResults = []            return        }                isSearching = true                let searchRequest = MKLocalSearch.Request()        searchRequest.naturalLanguageQuery = searchText                let search = MKLocalSearch(request: searchRequest)        search.start { response, error in            isSearching = false                        if let error = error {                print("Search error: \(error)")                return            }                        searchResults = response?.mapItems ?? []        }    }}class ExploreViewModel: ObservableObject {    @Published var clubs: [Club] = []    @Published var isLoading = false        func loadAllClubs() {        isLoading = true        Task {            do {                let fetchedClubs = try await ParseService.shared.fetchAllClubs()                await MainActor.run {                    self.clubs = fetchedClubs                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error loading clubs: \(error)")                }            }        }    }        func searchClubs(query: String) {        if query.isEmpty {            loadAllClubs()            return        }                isLoading = true        Task {            do {                let fetchedClubs = try await ParseService.shared.searchClubs(searchText: query)                await MainActor.run {                    self.clubs = fetchedClubs                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error searching clubs: \(error)")                }            }        }    }        func filterByCategory(_ category: ClubCategory) {        isLoading = true        Task {            do {                let fetchedClubs = try await ParseService.shared.filterClubsByCategory(category: category)                await MainActor.run {                    self.clubs = fetchedClubs                    self.isLoading = false                }            } catch {                await MainActor.run {                    self.isLoading = false                    print("Error filtering clubs: \(error)")                }            }        }    }}#Preview {    ExploreView()}