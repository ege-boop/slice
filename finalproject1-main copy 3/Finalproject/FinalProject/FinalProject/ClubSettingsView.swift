import SwiftUIimport PhotosUIimport ParseSwiftstruct ClubSettingsView: View {    let club: Club    @Environment(\.dismiss) var dismiss    @StateObject private var viewModel: ClubSettingsViewModel        init(club: Club) {        self.club = club        _viewModel = StateObject(wrappedValue: ClubSettingsViewModel(club: club))    }        var body: some View {        NavigationView {            List {                // Club Images Section (Admin/Leader only)                if viewModel.userRole == "admin" || viewModel.userRole == "leader" {                    Section {                        // Banner Image                        VStack(alignment: .leading, spacing: 12) {                            Text("Banner Image")                                .font(.system(size: 14, weight: .semibold))                                .foregroundColor(.gray)                                                        if let bannerImage = viewModel.selectedBannerImage {                                Image(uiImage: bannerImage)                                    .resizable()                                    .scaledToFill()                                    .frame(height: 120)                                    .clipped()                                    .cornerRadius(8)                            } else if let bannerURL = club.bannerImageURL,                                      !bannerURL.isEmpty,                                      let url = URL(string: bannerURL) {                                AsyncImage(url: url) { phase in                                    switch phase {                                    case .success(let image):                                        image                                            .resizable()                                            .scaledToFill()                                            .frame(height: 120)                                            .clipped()                                            .cornerRadius(8)                                    case .empty, .failure:                                        Rectangle()                                            .fill(Color.gray.opacity(0.3))                                            .frame(height: 120)                                            .cornerRadius(8)                                            .overlay(                                                Text("No Banner")                                                    .foregroundColor(.gray)                                            )                                    @unknown default:                                        EmptyView()                                    }                                }                            } else {                                Rectangle()                                    .fill(Color.gray.opacity(0.3))                                    .frame(height: 120)                                    .cornerRadius(8)                                    .overlay(                                        Text("No Banner")                                            .foregroundColor(.gray)                                    )                            }                                                        Button(action: {                                viewModel.showBannerPicker = true                            }) {                                Text("Change Banner")                                    .font(.system(size: 14, weight: .semibold))                                    .foregroundColor(.blue)                            }                        }                        .padding(.vertical, 8)                                                // Profile Image                        VStack(alignment: .leading, spacing: 12) {                            Text("Profile Image")                                .font(.system(size: 14, weight: .semibold))                                .foregroundColor(.gray)                                                        HStack(spacing: 16) {                                if let profileImage = viewModel.selectedProfileImage {                                    Image(uiImage: profileImage)                                        .resizable()                                        .scaledToFill()                                        .frame(width: 80, height: 80)                                        .clipShape(Circle())                                } else if let profileURL = club.profileImageURL,                                          !profileURL.isEmpty,                                          let url = URL(string: profileURL) {                                    AsyncImage(url: url) { phase in                                        switch phase {                                        case .success(let image):                                            image                                                .resizable()                                                .scaledToFill()                                                .frame(width: 80, height: 80)                                                .clipShape(Circle())                                        case .empty, .failure:                                            Circle()                                                .fill(Color.gray.opacity(0.3))                                                .frame(width: 80, height: 80)                                                .overlay(                                                    Text(club.name?.prefix(1).uppercased() ?? "C")                                                        .font(.system(size: 32, weight: .bold))                                                        .foregroundColor(.gray)                                                )                                        @unknown default:                                            EmptyView()                                        }                                    }                                } else {                                    Circle()                                        .fill(Color.gray.opacity(0.3))                                        .frame(width: 80, height: 80)                                        .overlay(                                            Text(club.name?.prefix(1).uppercased() ?? "C")                                                .font(.system(size: 32, weight: .bold))                                                .foregroundColor(.gray)                                        )                                }                                                                Button(action: {                                    viewModel.showProfilePicker = true                                }) {                                    Text("Change Profile Picture")                                        .font(.system(size: 14, weight: .semibold))                                        .foregroundColor(.blue)                                }                            }                        }                        .padding(.vertical, 8)                                                // Save Images Button                        if viewModel.selectedBannerImage != nil || viewModel.selectedProfileImage != nil {                            Button(action: {                                viewModel.saveImages()                            }) {                                if viewModel.isSavingImages {                                    HStack {                                        Spacer()                                        ProgressView()                                        Spacer()                                    }                                } else {                                    HStack {                                        Spacer()                                        Text("Save Images")                                            .font(.system(size: 16, weight: .semibold))                                            .foregroundColor(.white)                                        Spacer()                                    }                                    .padding(.vertical, 12)                                    .background(Color.black)                                    .cornerRadius(8)                                }                            }                            .disabled(viewModel.isSavingImages)                        }                    } header: {                        Text("Club Images")                    }                }                                // Edit Club Section (Admin/Leader only)                if viewModel.userRole == "admin" || viewModel.userRole == "leader" {                    Section {                        Button(action: {                            viewModel.showEditClub = true                        }) {                            HStack {                                Image(systemName: "pencil.circle.fill")                                    .foregroundColor(.black)                                Text("Edit Club Details")                                    .foregroundColor(.primary)                                Spacer()                                Image(systemName: "chevron.right")                                    .foregroundColor(.gray)                                    .font(.system(size: 14))                            }                        }                    } header: {                        Text("Club Management")                    }                }                                // Members Section                Section {                    if viewModel.isLoadingMembers {                        HStack {                            Spacer()                            ProgressView()                            Spacer()                        }                    } else {                        ForEach(viewModel.members, id: \.user.objectId) { member in                            MemberRow(                                member: member,                                currentUserRole: viewModel.userRole,                                onPromote: {                                    viewModel.promoteUser(userId: member.user.objectId ?? "")                                },                                onDemote: {                                    viewModel.demoteUser(userId: member.user.objectId ?? "")                                },                                onRemove: {                                    viewModel.removeUser(userId: member.user.objectId ?? "")                                }                            )                        }                    }                } header: {                    Text("Members (\(viewModel.members.count))")                }                                // Leave Club Section (if not admin)                if viewModel.userRole != "admin" {                    Section {                        Button(action: {                            viewModel.showLeaveAlert = true                        }) {                            HStack {                                Image(systemName: "rectangle.portrait.and.arrow.right")                                    .foregroundColor(.red)                                Text("Leave Club")                                    .foregroundColor(.red)                            }                        }                    }                }            }            .navigationTitle("Club Settings")            .navigationBarTitleDisplayMode(.inline)            .toolbar {                ToolbarItem(placement: .navigationBarTrailing) {                    Button("Done") {                        dismiss()                    }                }            }            .sheet(isPresented: $viewModel.showEditClub) {                EditClubView(club: club)            }            .sheet(isPresented: $viewModel.showBannerPicker) {                ImagePicker(image: $viewModel.selectedBannerImage)            }            .sheet(isPresented: $viewModel.showProfilePicker) {                ImagePicker(image: $viewModel.selectedProfileImage)            }            .alert("Leave Club", isPresented: $viewModel.showLeaveAlert) {                Button("Cancel", role: .cancel) { }                Button("Leave", role: .destructive) {                    viewModel.leaveClub {                        dismiss()                    }                }            } message: {                Text("Are you sure you want to leave this club?")            }            .alert("Error", isPresented: .constant(!viewModel.errorMessage.isEmpty)) {                Button("OK") {                    viewModel.errorMessage = ""                }            } message: {                Text(viewModel.errorMessage)            }            .alert("Success", isPresented: $viewModel.showSuccessAlert) {                Button("OK") {                    dismiss()                }            } message: {                Text("Club images updated successfully!")            }        }        .onAppear {            viewModel.loadData()        }    }}struct MemberRow: View {    let member: (user: User, role: String)    let currentUserRole: String?    let onPromote: () -> Void    let onDemote: () -> Void    let onRemove: () -> Void        var body: some View {        HStack(spacing: 12) {            // Avatar with profile picture            if let imageURL = member.user.profileImageURL,               !imageURL.isEmpty,               let url = URL(string: imageURL) {                AsyncImage(url: url) { phase in                    switch phase {                    case .success(let image):                        image                            .resizable()                            .scaledToFill()                            .frame(width: 44, height: 44)                            .clipShape(Circle())                    case .empty, .failure:                        Circle()                            .fill(Color.black)                            .frame(width: 44, height: 44)                            .overlay(                                Text(member.user.username?.prefix(1).uppercased() ?? "?")                                    .font(.system(size: 18, weight: .bold))                                    .foregroundColor(.white)                            )                    @unknown default:                        Circle()                            .fill(Color.black)                            .frame(width: 44, height: 44)                            .overlay(                                Text(member.user.username?.prefix(1).uppercased() ?? "?")                                    .font(.system(size: 18, weight: .bold))                                    .foregroundColor(.white)                            )                    }                }            } else {                Circle()                    .fill(Color.black)                    .frame(width: 44, height: 44)                    .overlay(                        Text(member.user.username?.prefix(1).uppercased() ?? "?")                            .font(.system(size: 18, weight: .bold))                            .foregroundColor(.white)                    )            }                        // Name and Role            VStack(alignment: .leading, spacing: 4) {                Text(member.user.username ?? "User")                    .font(.system(size: 16, weight: .semibold))                                HStack(spacing: 4) {                    Text(member.role.capitalized)                        .font(.system(size: 12))                        .foregroundColor(.white)                        .padding(.horizontal, 8)                        .padding(.vertical, 3)                        .background(roleColor(for: member.role))                        .cornerRadius(10)                }            }                        Spacer()                        // Actions Menu (Admin only)            if currentUserRole == "admin" && member.role != "admin" {                Menu {                    if member.role == "member" {                        Button(action: onPromote) {                            Label("Promote to Leader", systemImage: "arrow.up.circle")                        }                    }                                        if member.role == "leader" {                        Button(action: onDemote) {                            Label("Demote to Member", systemImage: "arrow.down.circle")                        }                    }                                        Divider()                                        Button(role: .destructive, action: onRemove) {                        Label("Remove from Club", systemImage: "person.badge.minus")                    }                } label: {                    Image(systemName: "ellipsis.circle")                        .foregroundColor(.black)                }            }        }        .padding(.vertical, 4)    }        func roleColor(for role: String) -> Color {        switch role {        case "admin":            return .red        case "leader":            return .orange        case "moderator":            return .blue        default:            return .gray        }    }}class ClubSettingsViewModel: ObservableObject {    let club: Club    @Published var members: [(user: User, role: String)] = []    @Published var userRole: String?    @Published var isLoadingMembers = false    @Published var showEditClub = false    @Published var showLeaveAlert = false    @Published var errorMessage = ""        // Image upload    @Published var selectedBannerImage: UIImage?    @Published var selectedProfileImage: UIImage?    @Published var showBannerPicker = false    @Published var showProfilePicker = false    @Published var isSavingImages = false    @Published var showSuccessAlert = false        init(club: Club) {        self.club = club    }        func loadData() {        getUserRole()        loadMembers()    }        func getUserRole() {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                Task {            do {                let role = try await ParseService.shared.getUserRoleInClub(userId: userId, clubId: clubId)                await MainActor.run {                    self.userRole = role                }            } catch {                print("Error getting user role: \(error)")            }        }    }        func loadMembers() {        guard let clubId = club.objectId else { return }                isLoadingMembers = true                Task {            do {                let members = try await ParseService.shared.getClubMembersWithRoles(clubId: clubId)                await MainActor.run {                    self.members = members                    self.isLoadingMembers = false                }            } catch {                await MainActor.run {                    self.isLoadingMembers = false                    print("Error loading members: \(error)")                }            }        }    }        func saveImages() {        var updatedClub = club                isSavingImages = true        errorMessage = ""                Task {            do {                // Upload banner if selected                if let bannerImage = selectedBannerImage {                    guard let imageData = bannerImage.jpegData(compressionQuality: 0.7) else {                        throw NSError(domain: "ClubSettings", code: 400, userInfo: [NSLocalizedDescriptionKey: "Failed to process banner image"])                    }                                        let parseFile = ParseFile(name: "club_banner_\(club.objectId ?? UUID().uuidString).jpg", data: imageData)                    let savedFile = try await parseFile.save()                    updatedClub.bannerImageURL = savedFile.url?.absoluteString                }                                // Upload profile if selected                if let profileImage = selectedProfileImage {                    guard let imageData = profileImage.jpegData(compressionQuality: 0.7) else {                        throw NSError(domain: "ClubSettings", code: 400, userInfo: [NSLocalizedDescriptionKey: "Failed to process profile image"])                    }                                        let parseFile = ParseFile(name: "club_profile_\(club.objectId ?? UUID().uuidString).jpg", data: imageData)                    let savedFile = try await parseFile.save()                    updatedClub.profileImageURL = savedFile.url?.absoluteString                }                                // Save club                _ = try await updatedClub.save()                                await MainActor.run {                    self.isSavingImages = false                    self.selectedBannerImage = nil                    self.selectedProfileImage = nil                    self.showSuccessAlert = true                }            } catch {                await MainActor.run {                    self.isSavingImages = false                    self.errorMessage = "Failed to update images: \(error.localizedDescription)"                }            }        }    }        func promoteUser(userId: String) {        guard let clubId = club.objectId else { return }                Task {            do {                try await ParseService.shared.promoteToLeader(userId: userId, clubId: clubId)                await MainActor.run {                    loadMembers()                }            } catch {                await MainActor.run {                    errorMessage = error.localizedDescription                }            }        }    }        func demoteUser(userId: String) {        guard let clubId = club.objectId else { return }                Task {            do {                try await ParseService.shared.demoteFromLeader(userId: userId, clubId: clubId)                await MainActor.run {                    loadMembers()                }            } catch {                await MainActor.run {                    errorMessage = error.localizedDescription                }            }        }    }        func removeUser(userId: String) {        guard let clubId = club.objectId else { return }                Task {            do {                try await ParseService.shared.removeMember(userId: userId, clubId: clubId)                await MainActor.run {                    loadMembers()                }            } catch {                await MainActor.run {                    errorMessage = error.localizedDescription                }            }        }    }        func leaveClub(completion: @escaping () -> Void) {        guard let userId = User.current?.objectId,              let clubId = club.objectId else { return }                Task {            do {                try await ParseService.shared.leaveClub(userId: userId, clubId: clubId)                await MainActor.run {                    completion()                }            } catch {                await MainActor.run {                    errorMessage = error.localizedDescription                }            }        }    }}#Preview {    ClubSettingsView(club: Club())}